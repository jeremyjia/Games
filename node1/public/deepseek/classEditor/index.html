<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>JavaScript类设计器</title>
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: Arial, sans-serif;
            background-color: #f0f0f0;
        }

        .nav {
            background: #333;
            color: white;
            padding: 10px;
            display: flex;
            gap: 15px;
        }

        .nav a {
            color: white;
            text-decoration: none;
        }

        .draggable {
            z-index: 1;
            position: absolute;
            background: white;
            border: 1px solid #ccc;
            border-radius: 5px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            min-width: 200px;
        }

        .toolbar-header {
            padding: 8px;
            background: #eee;
            cursor: move;
            border-bottom: 1px solid #ddd;
        }

        .toolbar-content {
            padding: 10px;
            display: flex;
            flex-direction: column;
            gap: 5px;
            height: calc(100% - 40px);
        }

        #id_4_draw_canvase {
            z-index: 0;
            position: fixed;
            top: 110px;
            left: 20px;
            right: 20px;
            height: 400px;
            background: white;
            border: 1px solid #ccc;
            border-radius: 5px;
        }

        #id_4_code_editor {
            top: 60px;
            left: 20px;
            width: 300px;
            height: 200px;
        }

        #id_4_class_toolbar {
            top: 60px;
            right: 20px;
            width: 320px;
            height: 500px;
            z-index: 10;
        }

        .editor-toolbar {
            padding: 8px 5px;
            background: #f5f5f5;
            border-top: 1px solid #ddd;
            display: flex;
            gap: 5px;
        }

        button {
            margin: 2px;
            padding: 5px 10px;
            border: none;
            color: white;
            border-radius: 3px;
            cursor: pointer;
            flex: none;
            transition: background 0.3s, box-shadow 0.3s;
        }

        button[data-class="0"] { background: #2196F3; }
        button[data-class="0"]:hover { background: #1976D2; }
        button[data-class="0"].active { background: #0D47A1; }

        button[data-class="1"] { background: #FF9800; }
        button[data-class="1"]:hover { background: #F57C00; }
        button[data-class="1"].active { background: #E65100; }

        button[data-class="2"] { background: #9C27B0; }
        button[data-class="2"]:hover { background: #7B1FA2; }
        button[data-class="2"].active { background: #4A148C; }

        #toggleEditorBtn {
            background: #4CAF50;
        }
        #toggleEditorBtn:hover {
            background: #45a049;
        }

        hr {
            width: 100%;
            margin: 8px 0;
            border: 0;
            border-top: 1px solid #ddd;
        }

        @media (max-width: 600px) {
            .draggable {
                width: 90% !important;
                left: 5% !important;
                right: 5% !important;
            }
            #id_4_code_editor {
                top: 120px;
            }
            #id_4_class_toolbar {
                top: 340px;
            }
        }

        .resize-handle {
            position: absolute;
            bottom: 0;
            right: 0;
            width: 12px;
            height: 12px;
            background: #4CAF50;
            cursor: nwse-resize;
            z-index: 2;
        }

        #id_4_code_editor textarea {
            width: 100%;
            height: calc(100% - 85px) !important;
            resize: none;
            border: none;
            padding: 8px;
            font-family: monospace;
        }

        .method-item {
            padding: 5px;
            margin: 3px 0;
            background: #f8f8f8;
            cursor: pointer;
            transition: background 0.2s;
        }

        .method-item:hover {
            background: #e0e0e0;
        }

        .method-list-container {
            flex: 1;
            overflow-y: auto;
            border-top: 1px solid #ddd;
            margin-top: 5px;
        }
    </style>
    <style>
        /* Add these styles to the existing CSS */
        #id_4_code_editor textarea {
            background-color: #f8f9fa;
            border: 1px solid #e9ecef;
            color: #2d333a;
            font-family: 'Consolas', monospace;
            font-size: 14px;
            line-height: 1.6;
            transition: all 0.2s ease;
        }
    
        #id_4_code_editor textarea:focus {
            background-color: #ffffff;
            border-color: #2196F3;
            box-shadow: 0 0 0 2px rgba(33, 150, 243, 0.1);
            outline: none;
        }
    
        #updateBtn {
            background: #4a5568 !important;
            padding: 8px 16px;
            border-radius: 4px;
            transition: all 0.2s ease;
        }
    
        #updateBtn:hover {
            background: #2d3748 !important;
            transform: translateY(-1px);
        }
    
        #updateBtn:active {
            background: #1a202c !important;
            transform: translateY(0);
        }
    
        .editor-toolbar {
            background: #f8fafc !important;
            border-top: 1px solid #e2e8f0;
            padding: 10px;
        }
    </style>

</head>
<body>
    <div class="nav">
        <a href="https://www.deepseek.com">前往DeepSeek</a>
        <a href="temp.html">temp.html</a>
        <a href="jp1.html">jp1.html</a>
        <a href="c1.html">c1.html</a>
        <a href="d1.html">d1.html</a>
        <a href="d2.html">d2.html</a>
        <a href="c1.md">c1.md</a>
        <a href="d1.md">d1.md</a>
    </div>
    <canvas id="id_4_draw_canvase"></canvas>
    
    <div class="draggable" id="id_4_code_editor">
        <div class="toolbar-header">代码编辑器</div>
        <div class="toolbar-content">
            <textarea></textarea>
            <div class="editor-toolbar">
                <button id="updateBtn">refresh</button>
            </div>
            <div class="resize-handle"></div>
        </div>
    </div>

    <div class="draggable" id="id_4_class_toolbar">
        <div class="toolbar-header">类工具箱</div>
        <div class="toolbar-content">
            <div style="display: flex; gap: 5px; flex-wrap: wrap;">
                <button data-class="0">Class1</button>
                <button data-class="1">Class2</button>
                <button data-class="2">Class3</button>
                <button id="toggleEditorBtn">Toggle Editor</button>
            </div>
            <hr>
            <div class="method-list-container">
                <div id="methodList"></div>
            </div>
        </div>
    </div>

    <script>
        // 在全局添加实例存储对象
        const classInstances = {
            0: null,
            1: null,
            2: null // 对应Class3的实例存储
        };


        const canvas = document.getElementById('id_4_draw_canvase');
        let ctx = null;
        
        function initCanvas() {
            canvas.width = canvas.offsetWidth;
            canvas.height = canvas.offsetHeight;
            ctx = canvas.getContext('2d');
            ctx.drawNoteTest = function(cx,ns) {
                    cx.save(); 
                    for(let i =0; i < ns.length; i++) { 
                        const parsed = cx.parseNote(ns[i]);
                        cx.drawTextNote(
                            cx,
                            50 + i * 50,
                            100,
                            parsed
                        );
                    }
                    cx.restore();
            };
            ctx.drawTextNote = function(cx, x, y, note) {
                const _tntc = {
                    noteWidth: 80,
                    baseY: 250,
                    canvasPadding: 40,
                    fontSize: 36,
                    highOctaveDotOffset: 15,
                    lowOctaveDotOffset: 15,
                    slashVerticalOffset: 5,         // 调整为更靠近音符
                    slashLineSpacing: 10,           // 增加横线间距
                    slashLineLength: 24,
                    octaveDotSpacing: 10,
                    dashHorizontalOffset: 25,
                    dashLineLength: 14,
                    dashLineSpacing: 20
                };
                        
                cx.save();
                cx.font = _tntc.fontSize + "px Arial";
                cx.textAlign = 'center';
                cx.textBaseline = 'middle';

                cx.fillStyle = note.isRest ? '#FF4444' : '#000';
                cx.fillText(note.value, x, y);

                // 高音点绘制（保持不变）...
                if (note.highOctave > 0) {
                    const noteTop = y - _tntc.fontSize/2;
                    const startY = noteTop - _tntc.highOctaveDotOffset;
                    for (let i = 0; i < note.highOctave; i++) {
                        cx.beginPath();
                        cx.arc(x, startY - i * _tntc.octaveDotSpacing, 3, 0, Math.PI * 2);
                        cx.fill();
                    }
                }

                if (note.slash > 0) {
                    cx.strokeStyle = '#000';
                    cx.lineWidth = 2;
                    const baseY = y + _tntc.fontSize/2 + _tntc.slashVerticalOffset; // 基于字体大小计算位置
                    for (let i = 0; i < note.slash; i++) {
                        cx.beginPath();
                        cx.moveTo(
                            x - _tntc.slashLineLength/2, 
                            baseY + i * _tntc.slashLineSpacing
                        );
                        cx.lineTo(
                            x + _tntc.slashLineLength/2, 
                            baseY + i * _tntc.slashLineSpacing
                        );
                        cx.stroke();
                    }
                }

                // 低音点绘制（保持不变）...
                if (note.lowOctave > 0) {
                    const slashHeight = note.slash > 0 
                        ? _tntc.slashVerticalOffset + (note.slash - 1) * _tntc.slashLineSpacing 
                        : 0;
                    const baseY = y + slashHeight + _tntc.lowOctaveDotOffset;
                    for (let i = 0; i < note.lowOctave; i++) {
                        cx.beginPath();
                        cx.arc(x, baseY + i * _tntc.octaveDotSpacing, 3, 0, Math.PI * 2);
                        cx.fill();
                    }
                }

                // 修改后的右侧横杠绘制（水平排列）
                if (note.dash > 0) {
                    cx.strokeStyle = '#000';
                    cx.lineWidth = 2;
                    const baseX = x + _tntc.dashHorizontalOffset;
                    const baseY = y;  // 保持同一水平线
                    for (let i = 0; i < note.dash; i++) {
                        cx.beginPath();
                        cx.moveTo(
                            baseX + i * _tntc.dashLineSpacing,
                            baseY
                        );
                        cx.lineTo(
                            baseX + i * _tntc.dashLineSpacing + _tntc.dashLineLength,
                            baseY
                        );
                        cx.stroke();
                    }
                }
                cx.restore();
            }
            ctx.parseNote = function(noteStr) {
                const numMatch = noteStr.match(/^[0-7]/);
                if (!numMatch) return { value: '0', highOctave: 0, lowOctave: 0, slash: 0, dash: 0 };
                
                const symbols = noteStr.slice(1);
                let highOctave = 0, lowOctave = 0, slash = 0, dash = 0;

                for (const c of symbols) {
                    switch(c) {
                        case "'": highOctave++; break;
                        case ",": lowOctave++; break;
                        case "/": slash++; break;
                        case "-": dash++; break;
                    }
                }

                return {
                    value: numMatch[0],
                    highOctave,
                    lowOctave,
                    slash,
                    dash,
                    isRest: numMatch[0] === '0'
                };
            }
        }
        window.addEventListener('load', initCanvas);
        window.addEventListener('resize', initCanvas);

        // 窗口大小调整处理
        document.querySelectorAll('.resize-handle').forEach(handle => {
            let isResizing = false;
            let startX, startY, startWidth, startHeight;
            const editor = handle.closest('.draggable');

            const handleEvent = {
                start: (e) => {
                    isResizing = true;
                    startX = (e.clientX || e.touches[0].clientX);
                    startY = (e.clientY || e.touches[0].clientY);
                    startWidth = editor.offsetWidth;
                    startHeight = editor.offsetHeight;
                    editor.style.transition = 'none';
                },
                move: (e) => {
                    if (!isResizing) return;
                    const currentX = (e.clientX || e.touches[0].clientX);
                    const currentY = (e.clientY || e.touches[0].clientY);
                    
                    editor.style.width = `${Math.max(200, startWidth + (currentX - startX))}px`;
                    editor.style.height = `${Math.max(150, startHeight + (currentY - startY))}px`;
                },
                end: () => {
                    isResizing = false;
                    editor.style.transition = 'all 0.3s';
                }
            };

            handle.addEventListener('mousedown', handleEvent.start);
            document.addEventListener('mousemove', handleEvent.move);
            document.addEventListener('mouseup', handleEvent.end);
            handle.addEventListener('touchstart', handleEvent.start);
            document.addEventListener('touchmove', handleEvent.move);
            document.addEventListener('touchend', handleEvent.end);
        });

        // 拖拽处理
        document.querySelectorAll('.draggable').forEach(element => {
            let isDragging = false;
            let initialX = 0, initialY = 0;

            const dragHandler = {
                start: (e) => {
                    initialX = (e.clientX || e.touches[0].clientX);
                    initialY = (e.clientY || e.touches[0].clientY);
                    isDragging = true;
                    element.style.transition = 'none';
                },
                move: (e) => {
                    if (!isDragging) return;
                    const currentX = (e.clientX || e.touches[0].clientX);
                    const currentY = (e.clientY || e.touches[0].clientY);
                    
                    element.style.left = `${element.offsetLeft + (currentX - initialX)}px`;
                    element.style.top = `${element.offsetTop + (currentY - initialY)}px`;
                    
                    initialX = currentX;
                    initialY = currentY;
                },
                end: () => {
                    isDragging = false;
                    element.style.transition = 'all 0.3s';
                }
            };

            element.querySelector('.toolbar-header').addEventListener('mousedown', dragHandler.start);
            element.querySelector('.toolbar-header').addEventListener('touchstart', dragHandler.start);
            document.addEventListener('mousemove', dragHandler.move);
            document.addEventListener('touchmove', dragHandler.move);
            document.addEventListener('mouseup', dragHandler.end);
            document.addEventListener('touchend', dragHandler.end);
        });


        // 添加全局拖拽状态管理
    let isDraggingBox = false;
    let dragStartX = 0;
    let dragStartY = 0;
    let selectedInstance = null;

    // Canvas事件监听
    canvas.addEventListener('mousedown', handleCanvasDown);
    canvas.addEventListener('mousemove', handleCanvasMove);
    canvas.addEventListener('mouseup', handleCanvasUp);

    function handleCanvasDown(e) {
        const rect = canvas.getBoundingClientRect();
        const mouseX = e.clientX - rect.left;
        const mouseY = e.clientY - rect.top;

        // 只检测当前激活类的实例
        const activeBtn = document.querySelector('[data-class].active');
        if (!activeBtn) return;
        
        const instance = classInstances[activeBtn.dataset.class];
        if (!instance) return;

        const hitIndex = instance.checkHitBox(mouseX, mouseY);
        if(hitIndex > -1) {
            isDraggingBox = true;
            selectedInstance = instance;
            instance.selectedBox = hitIndex;
            dragStartX = mouseX;
            dragStartY = mouseY;
        }
    }

    function handleCanvasMove(e) {
        if(!isDraggingBox) return;

        const rect = canvas.getBoundingClientRect();
        const mouseX = e.clientX - rect.left;
        const mouseY = e.clientY - rect.top;

        const dx = mouseX - dragStartX;
        const dy = mouseY - dragStartY;

        if(selectedInstance) {
            selectedInstance.moveSelectedBox(dx, dy);
            dragStartX = mouseX;
            dragStartY = mouseY;
            
            // 清除并重绘
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            selectedInstance.drawAllBoxs(ctx);
        }
    }

    function handleCanvasUp() {
        isDraggingBox = false;
        selectedInstance = null;
    }

        // 类模板定义
        const classTemplates = [
            `class Class1 {
                constructor() {
                    this.name = 'Class1';
                }
                
                clearCanvas(cx) { 
                    cx.clearRect(0, 0, cx.canvas.width, cx.canvas.height);
                }
                    
                drawCircle(cx) { 
                    const x = Math.random() * cx.canvas.width;
                    const y = Math.random() * cx.canvas.height;
                    cx.beginPath();
                    cx.arc(x, y, 20, 0, Math.PI * 2);
                    cx.fillStyle = '#' + Math.floor(Math.random()*16777215).toString(16).padStart(6, '0');
                    cx.fill();
                }
                drawMyName(cx) {
                    cx.save();
                    cx.font = "24px Arial";
                    cx.fillStyle = "#2196F3";
                    cx.textBaseline = "middle";
                    cx.textAlign = "center";
                    
                    const x = cx.canvas.width/4;
                    const y = cx.canvas.height/4;
                    cx.fillText(this.name, x, y);
                    
                    cx.shadowColor = "rgba(0,0,0,0.3)";
                    cx.shadowOffsetX = 2;
                    cx.shadowOffsetY = 2;
                    cx.shadowBlur = 4;
 
                    cx.restore();
                }
            }`,

            `class Class2 {
                constructor() {
                    this.value = 0;
                    this.name = "class2_name"; 
                }
                 
                Test(cx) { 
                    const ns = ["1---","2//","3//","4//","1,,","5,","2'","7,,-","2''---"]; 
                    cx.drawNoteTest(cx,ns); 
                } 
            }` 
        ,

           `class Class3 {
        constructor(name) {
            this.n = 0;
            this.x = 10;
            this.y = 10;
            this.dx = 50;
            this.boxs = [];
            this.name = name || 'Default';
            this.selectedBox = null;
            this.boxSize = 20;
        }
        
        draw_boxs(cx) {
            if(this.n>5){
                this.n = 0;
                this.x = 10;
                this.y += 10;
            }
            this.x += this.dx;
            this.n++;

            this.boxs.push({ 
                x: this.x, 
                y: this.y,
                originalX: this.x,
                originalY: this.y
            });
            this.drawAllBoxs(cx);
        }
        
        drawAllBoxs(cx) {
            cx.fillStyle = '#FF5722';
            cx.strokeStyle = '#333';
            this.boxs.forEach((point, index) => {

                cx.beginPath();
                cx.rect(
                    point.x - this.boxSize/2, 
                    point.y - this.boxSize/2, 
                    this.boxSize, 
                    this.boxSize
                );
                
                if(index === this.selectedBox) {
                    cx.fillStyle = '#2196F3';
                } else {
                    const gradient = cx.createLinearGradient(
                        point.x - this.boxSize/2, 
                        point.y - this.boxSize/2,
                        point.x + this.boxSize/2,
                        point.y + this.boxSize/2
                    );
                    gradient.addColorStop(0, '#FF9800');
                    gradient.addColorStop(1, '#FF5722');
                    cx.fillStyle = gradient;
                }
                
                cx.fill();
                cx.stroke();
            });
        }
        
        checkHitBox(x, y) {
            return this.boxs.findIndex(point => {
                return x > point.x - this.boxSize/2 && 
                       x < point.x + this.boxSize/2 && 
                       y > point.y - this.boxSize/2 && 
                       y < point.y + this.boxSize/2;
            });
        }
        
        moveSelectedBox(dx, dy) {
            if(this.selectedBox !== null) {
                this.boxs[this.selectedBox].x += dx;
                this.boxs[this.selectedBox].y += dy;
            }
        }
    }`


            ,
        ];

        const textarea = document.querySelector('textarea');

        // 类按钮点击处理
        document.querySelectorAll('[data-class]').forEach(btn => {
            btn.addEventListener('click', async () => {
                // 更新按钮状态
                document.querySelectorAll('[data-class]').forEach(b => {
                    b.classList.remove('active');
                    b.style.order = "";
                });
                btn.classList.add('active');
                btn.style.order = -1;

                // 加载类模板
                textarea.value = classTemplates[btn.dataset.class];

                const classIndex = btn.dataset.class;
                if (!classInstances[classIndex]) {
                    const cls = await createClass(classTemplates[classIndex]);
                    classInstances[classIndex] = new cls();
                }
                showMethods(classInstances[classIndex]);
                    });
                });

        document.getElementById('updateBtn').addEventListener('click', async () => {
            const activeBtn = document.querySelector('[data-class].active');
            if (activeBtn) {
                const classIndex = activeBtn.dataset.class;
                classTemplates[classIndex] = textarea.value;

                try {
                    // 重新创建类实例
                    const cls = await createClass(classTemplates[classIndex]);
                    classInstances[classIndex] = new cls();
                    // 更新方法列表
                    showMethods(classInstances[classIndex]);
                    alert('类定义已更新并刷新方法列表');
                } catch (e) {
                    alert('类定义错误: ' + e.message);
                    console.error(e);
                }
            } else {
                alert('请先选择要更新的类');
            }
        });

        // 编辑器切换
        document.getElementById('toggleEditorBtn').addEventListener('click', function() {
            const editor = document.getElementById('id_4_code_editor');
            editor.style.display = editor.style.display === 'none' ? 'block' : 'none';
        });

        // 类创建函数
        function createClass(code) {
            return new Promise((resolve, reject) => {
                try {
                    resolve(new Function(`return ${code}`)());
                } catch (e) {
                    reject(e);
                }
            });
        }

        // 显示方法列表
        function showMethods(instance) {
            const methodList = document.getElementById('methodList');
            methodList.innerHTML = '';
            
            Object.getOwnPropertyNames(Object.getPrototypeOf(instance))
                .filter(m => m !== 'constructor' && typeof instance[m] === 'function')
                .forEach(m => {
                    const div = document.createElement('div');
                    div.className = 'method-item';
                    div.textContent = m;
                    div.addEventListener('click', () => {
                        try {
                            instance[m](ctx);
                            if (m === 'drawCircle') ctx.stroke();
                        } catch (e) {
                            console.error('方法执行失败:', e);
                        }
                    });
                    methodList.appendChild(div);
                });
        }
    </script>
</body>
</html>
<!--


 

when refresh class, showMethods should upatde too
-->