<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
</head>
<body>
<script>
class MusicNotationApp {
    constructor() {
        this.CONFIG = {
            noteWidth: 80,
            baseY: 250,
            canvasPadding: 40,
            fontSize: 36,
            highOctaveDotOffset: 15,
            lowOctaveDotOffset: 15,
            slashVerticalOffset: 20,
            octaveDotSpacing: 10,
            slashLineSpacing: 6,
            slashLineLength: 24,
            dashHorizontalOffset: 25,
            dashLineLength: 14,
            dashLineSpacing: 20
        };

        this.EXAMPLES = {
            simple: "1 2 3 4 5 6 7 0",
            octave: "1'' 2' 3 4, 5,, 6 7' 0",
            duration: "1/ 2// 3- 4--- 5 6/ 7 0--",
            rest: "0 0/ 0- 0-- 0 0// 0 0---",
            mixed: "1' 2// 3,, 4- 0 5''/ 6-- 7,,"
        };

        this.initStyles();
        this.createDOM();
        this.bindEvents();
        this.drawSheetMusic();
    }

    initStyles() {
        const style = document.createElement('style');
        style.textContent = `
            body {
                padding: 20px;
                font-family: Arial, sans-serif;
            }
            #inputBox {
                width: 100%;
                height: 80px;
                margin-bottom: 15px;
                padding: 10px;
                box-sizing: border-box;
                border: 2px solid #ccc;
                border-radius: 4px;
            }
            #canvasContainer {
                overflow-x: auto;
                margin-top: 20px;
                border: 1px solid #ddd;
                padding: 10px;
            }
            canvas {
                background-color: white;
            }
            .toolbar {
                margin: 10px 0;
            }
            button {
                padding: 10px 20px;
                font-size: 14px;
                margin: 5px;
                cursor: pointer;
                background-color: #4CAF50;
                color: white;
                border: none;
                border-radius: 4px;
                transition: background 0.3s;
            }
            button:hover {
                background-color: #45a049;
            }
            @media (max-width: 600px) {
                #inputBox { height: 120px; }
                button { padding: 8px 16px; }
            }
        `;
        document.head.appendChild(style);
    }

    createDOM() {
        this.container = document.createElement('div');
        
        this.inputBox = document.createElement('textarea');
        this.inputBox.id = 'inputBox';
        this.inputBox.placeholder = '输入简谱示例：\n1\' 2 3- 4// 5, 6\' 7 0';
        
        this.toolbar = document.createElement('div');
        this.toolbar.className = 'toolbar';
        
        this.canvasContainer = document.createElement('div');
        this.canvasContainer.id = 'canvasContainer';
        this.canvas = document.createElement('canvas');
        this.canvas.id = 'musicCanvas';
        this.canvasContainer.appendChild(this.canvas);

        this.createButtons();
        
        this.container.appendChild(this.inputBox);
        this.container.appendChild(this.toolbar);
        this.container.appendChild(this.canvasContainer);
        document.body.appendChild(this.container);
    }

    createButtons() {
        const examples = [
            { text: '简单音符', type: 'simple' },
            { text: '高低八度', type: 'octave' },
            { text: '时值示例', type: 'duration' },
            { text: '休止符', type: 'rest' },
            { text: '混合示例', type: 'mixed' }
        ];

        examples.forEach(example => {
            const btn = document.createElement('button');
            btn.textContent = example.text;
            btn.addEventListener('click', () => this.createExample(example.type));
            this.toolbar.appendChild(btn);
        });
    }

    bindEvents() {
        let drawTimeout;
        this.inputBox.addEventListener('input', () => {
            clearTimeout(drawTimeout);
            drawTimeout = setTimeout(() => this.drawSheetMusic(), 300);
        });
    }

    createExample(type) {
        this.inputBox.value = this.EXAMPLES[type];
        this.drawSheetMusic();
    }

    drawSheetMusic() {
        const input = this.inputBox.value.trim();
        const ctx = this.canvas.getContext('2d');
        ctx.clearRect(0, 0, this.canvas.width, this.canvas.height);

        const notes = input.split(/\s+/).filter(n => n);
        this.canvas.width = Math.max(800, notes.length * this.CONFIG.noteWidth + this.CONFIG.canvasPadding * 2);
        this.canvas.height = 400;

        notes.forEach((noteStr, index) => {
            const parsed = this.parseNote(noteStr);
            this.drawTextNote(
                ctx,
                this.CONFIG.canvasPadding + index * this.CONFIG.noteWidth,
                this.CONFIG.baseY,
                parsed
            );
        });
    }

    parseNote(noteStr) {
        const numMatch = noteStr.match(/^\d/);
        if (!numMatch) return { value: '0', highOctave: 0, lowOctave: 0, slash: 0, dash: 0 };
        
        const symbols = noteStr.slice(1);
        let highOctave = 0, lowOctave = 0, slash = 0, dash = 0;

        for (const c of symbols) {
            switch(c) {
                case "'": highOctave++; break;
                case ",": lowOctave++; break;
                case "/": slash++; break;
                case "-": dash++; break;
            }
        }

        return {
            value: numMatch[0],
            highOctave: highOctave,
            lowOctave: lowOctave,
            slash: slash,
            dash: dash,
            isRest: numMatch[0] === '0'
        };
    }

    drawTextNote(ctx, x, y, note) {
        ctx.save();
        ctx.font = `${this.CONFIG.fontSize}px Arial`;
        ctx.textAlign = 'center';
        ctx.textBaseline = 'middle';

        ctx.fillStyle = note.isRest ? '#FF4444' : '#000';
        ctx.fillText(note.value, x, y);

        // 绘制高八度点
        if (note.highOctave > 0) {
            const noteTop = y - this.CONFIG.fontSize/2;
            const startY = noteTop - this.CONFIG.highOctaveDotOffset;
            for (let i = 0; i < note.highOctave; i++) {
                ctx.beginPath();
                ctx.arc(x, startY - i * this.CONFIG.octaveDotSpacing, 3, 0, Math.PI * 2);
                ctx.fill();
            }
        }

        // 绘制减时线
        if (note.slash > 0) {
            ctx.strokeStyle = '#000';
            ctx.lineWidth = 2;
            const baseY = y + this.CONFIG.slashVerticalOffset;
            for (let i = 0; i < note.slash; i++) {
                ctx.beginPath();
                ctx.moveTo(x - this.CONFIG.slashLineLength/2, baseY + i * this.CONFIG.slashLineSpacing);
                ctx.lineTo(x + this.CONFIG.slashLineLength/2, baseY + i * this.CONFIG.slashLineSpacing);
                ctx.stroke();
            }
        }

        // 绘制低八度点
        if (note.lowOctave > 0) {
            const slashHeight = note.slash > 0 
                ? this.CONFIG.slashVerticalOffset + (note.slash - 1) * this.CONFIG.slashLineSpacing 
                : 0;
            const baseY = y + slashHeight + this.CONFIG.lowOctaveDotOffset;
            for (let i = 0; i < note.lowOctave; i++) {
                ctx.beginPath();
                ctx.arc(x, baseY + i * this.CONFIG.octaveDotSpacing, 3, 0, Math.PI * 2);
                ctx.fill();
            }
        }

        // 绘制增时线
        if (note.dash > 0) {
            ctx.strokeStyle = '#000';
            ctx.lineWidth = 2;
            const baseX = x + this.CONFIG.dashHorizontalOffset;
            for (let i = 0; i < note.dash; i++) {
                const lineX = baseX + i * (this.CONFIG.dashLineLength + 6);
                ctx.beginPath();
                ctx.moveTo(lineX, y);
                ctx.lineTo(lineX + this.CONFIG.dashLineLength, y);
                ctx.stroke();
            }
        }
        ctx.restore();
    }
}

// 初始化应用
new MusicNotationApp();
</script>
</body>
</html>