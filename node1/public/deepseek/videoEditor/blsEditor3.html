<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>漂泊者视频编辑器</title>
    <style>
        :root {
            --primary-color: #483D8B;
            --secondary-color: #00FF7F;
        }

        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 10px;
            display: grid;
            grid-template-columns: 1fr 300px;
            gap: 10px;
        }

        #preview {
            background: #000;
            position: relative;
            overflow: hidden;
        }

        .edit-panel {
            background: #f5f5f5;
            padding: 10px;
            border-radius: 5px;
        }

        .section {
            margin-bottom: 15px;
            padding: 10px;
            background: white;
            border-radius: 5px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .form-group {
            margin: 10px 0;
        }

        input, select, button {
            width: 100%;
            padding: 8px;
            margin: 5px 0;
            box-sizing: border-box;
        }

        button {
            background: var(--primary-color);
            color: white;
            border: none;
            padding: 10px;
            cursor: pointer;
        }

        .scene-list {
            max-height: 200px;
            overflow-y: auto;
        }

        .object-item {
            cursor: pointer;
            padding: 5px;
            margin: 2px 0;
            background: #eee;
        }

        @media (max-width: 768px) {
            body {
                grid-template-columns: 1fr;
            }
            
            .edit-panel {
                order: -1;
            }
        }
        /* 原有样式保持不变，新增canvas样式 */
        #preview {
            background: #000;
            position: relative;
            overflow: hidden;
        }
        #previewCanvas {
            width: 100%;
            height: 100%;
        }
    </style>
</head>
<body>
    <div id="preview"><canvas id="previewCanvas"></canvas></div>
    <div class="edit-panel">
        <div class="section">
            <h3>全局设置</h3>
            <div class="form-group">
                <label>帧率 (fps):</label>
                <input type="number" id="frameRate" value="1" min="1">
            </div>
            <!-- 其他全局设置 -->
        </div>

        <div class="section">
            <h3>场景管理</h3>
            <div class="scene-list" id="sceneList"></div>
            <button onclick="addScene()">添加场景</button>
        </div>

        <div class="section" id="sceneEdit">
            <h3>场景编辑</h3>
            <!-- 场景编辑表单 -->
        </div>

        <div class="section">
            <h3>数据操作</h3>
            <button onclick="importJSON()">导入JSON</button>
            <button onclick="exportJSON()">导出JSON</button>
            <button onclick="playPreview()">播放预览</button>
        </div>
    </div>

    <script>
        class VideoEditor {
            constructor() {
                this.data = {
                    version: "0.0.1",
                    width: 1024,
                    height: 768,
                    rate: 1,
                    frames: []
                };
                this.currentScene = null;
                this.renderer = new VideoRenderer(document.getElementById('previewCanvas'));
                this.initCanvas();
            }

            initCanvas() {
                const canvas = this.renderer.canvas;
                canvas.width = this.data.width;
                canvas.height = this.data.height;
            }

            addScene(time = 5) {
                const newScene = {
                    number: this.data.frames.length + 1,
                    time: time,
                    objects: [],
                    backgroundColor: "72,61,139"
                };
                this.data.frames.push(newScene);
                this.currentScene = newScene;
                return newScene;
            }

            getScene(number) {
                return this.data.frames.find(s => s.number === number);
            }

            updateScene(scene) {
                const index = this.data.frames.findIndex(s => s.number === scene.number);
                if (index >= 0) this.data.frames[index] = scene;
            }

            addTextObject(scene, text = "新文本") {
                const newText = {
                    id: Date.now(),
                    text: text,
                    x: 100,
                    y: 100,
                    size: 50,
                    color: "255,255,255"
                };
                scene.objects.push(newText);
                return newText;
            }

            exportJSON() {
                return JSON.stringify(this.data, null, 2);
            }

            importJSON(json) {
                this.data = JSON.parse(json);
                this.initCanvas();
            }
        }

        class VideoRenderer {
            constructor(canvas) {
                this.canvas = canvas;
                this.ctx = canvas.getContext('2d');
                this.ctx.textBaseline = 'top';
            }

            render(scene) {
                this.ctx.clearRect(0, 0, this.canvas.width, this.canvas.height);
                
                // 绘制背景
                this.ctx.fillStyle = `rgb(${scene.backgroundColor})`;
                this.ctx.fillRect(0, 0, this.canvas.width, this.canvas.height);

                // 绘制对象
                scene.objects.forEach(obj => {
                    if (obj.text) {
                        this.ctx.fillStyle = `rgb(${obj.color})`;
                        this.ctx.font = `${obj.size}px Arial`;
                        this.ctx.fillText(obj.text, obj.x, obj.y);
                    }
                });
            }
        }

        // 初始化编辑器实例
        const editor = new VideoEditor();

        // UI操作函数
        function addScene() {
            const scene = editor.addScene();
            renderSceneList();
            selectScene(scene.number);
        }

        function selectScene(number) {
            editor.currentScene = editor.getScene(number);
            renderSceneEditor();
            updatePreview();
        }

        function updateSceneProp(prop, value) {
            editor.currentScene[prop] = isNaN(value) ? value : Number(value);
            updatePreview();
        }

        function addTextObject() {
            editor.addTextObject(editor.currentScene);
            renderSceneEditor();
            updatePreview();
        }

        function renderSceneList() {
            const list = document.getElementById('sceneList');
            list.innerHTML = editor.data.frames.map(scene => `
                <div class="scene-item" onclick="selectScene(${scene.number})">
                    场景 ${scene.number} (${scene.time}s)
                </div>
            `).join('');
        }

        function renderSceneEditor() {
            const scene = editor.currentScene;
            const container = document.getElementById('sceneEdit');
            if (!scene) return;

            container.innerHTML = `
                <div class="form-group">
                    <label>持续时间 (秒):</label>
                    <input type="number" value="${scene.time}" 
                           onchange="updateSceneProp('time', this.value)">
                </div>
                <h4>对象列表</h4>
                <div class="object-list">
                    ${scene.objects.map(obj => `
                        <div class="object-item" onclick="selectObject(${obj.id})">
                            ${obj.text}
                        </div>
                    `).join('')}
                </div>
                <button onclick="addTextObject()">添加文本</button>
            `;
        }

        function updatePreview() {
            if (editor.currentScene) {
                editor.renderer.render(editor.currentScene);
            }
        }

        // 数据操作
        function exportJSON() {
            const data = editor.exportJSON();
            const blob = new Blob([data], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'video-project.json';
            a.click();
        }

        function importJSON() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = 'application/json';
            input.onchange = e => {
                const file = e.target.files[0];
                const reader = new FileReader();
                reader.onload = () => {
                    editor.importJSON(reader.result);
                    renderSceneList();
                    selectScene(editor.data.frames[0]?.number);
                };
                reader.readAsText(file);
            };
            input.click();
        }

        // 初始化示例场景
        editor.addScene();
        renderSceneList();
        selectScene(1);
    </script>
</body>
</html>