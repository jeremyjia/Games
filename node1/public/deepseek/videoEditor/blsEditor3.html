<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>漂泊者视频编辑器</title>
    <style>
        :root {
            --primary-color: #483D8B;
            --secondary-color: #00FF7F;
        }

        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 10px;
            display: grid;
            grid-template-columns: 1fr 300px;
            gap: 10px;
        }

        #preview {
            aspect-ratio: 16/9;
            background: #000;
            position: relative;
            overflow: hidden;
        }

        .edit-panel {
            background: #f5f5f5;
            padding: 10px;
            border-radius: 5px;
        }

        .section {
            margin-bottom: 15px;
            padding: 10px;
            background: white;
            border-radius: 5px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .form-group {
            margin: 10px 0;
        }

        input, select, button {
            width: 100%;
            padding: 8px;
            margin: 5px 0;
            box-sizing: border-box;
        }

        button {
            background: var(--primary-color);
            color: white;
            border: none;
            padding: 10px;
            cursor: pointer;
        }

        .scene-list {
            max-height: 200px;
            overflow-y: auto;
        }

        .object-item {
            cursor: pointer;
            padding: 5px;
            margin: 2px 0;
            background: #eee;
        }
        .scene-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px;
            margin: 4px 0;
        }
        .delete-btn {
            background: #ff4444;
            color: white;
            border: none;
            padding: 4px 8px;
            border-radius: 3px;
            cursor: pointer;
        }
        .delete-btn:hover {
            background: #cc0000;
        }
        .scene-item.active {
            background-color: var(--primary-color);
            color: white;
            font-weight: bold;
        }
        @media (max-width: 768px) {
            body {
                grid-template-columns: 1fr;
            }
            
            .edit-panel {
                order: -1;
            }
        }
        /* 原有样式保持不变，新增canvas样式 */
        #preview {
            background: #000;
            position: relative;
            overflow: hidden;
        }
        #previewCanvas {
            width: 100%;
            height: 100%;
            object-fit: contain;
        }
    </style>
</head>
<body>
    <div id="preview"><canvas id="previewCanvas"></canvas></div>
    <div class="edit-panel">
        <div class="section">
            <h3>全局设置</h3>
            <div class="form-group">
                <label>帧率 (fps):</label>
                <input type="number" id="frameRate" value="1" min="1">
            </div>
            <!-- 其他全局设置 -->
        </div>

        <div class="section">
            <h3>场景管理</h3>
            <div class="scene-list" id="sceneList"></div>
            <button onclick="addScene()">添加场景</button>
        </div>

        <div class="section" id="sceneEdit">
            <h3>场景编辑</h3>
            <!-- 场景编辑表单 -->
        </div>

        <div class="section">
            <h3>数据操作</h3>
            <button onclick="importJSON()">导入JSON</button>
            <button onclick="exportJSON()">导出JSON</button>
            <button onclick="playPreview()">播放预览</button>
        </div>
    </div>

    <script>
    
    document.getElementById('frameRate').addEventListener('change', function(e) {
        editor.data.rate = parseInt(e.target.value) || 1;
    });
        let isPlaying = false;
let startTime;

function playPreview() {
    if (!editor.currentScene) return;
    
    isPlaying = !isPlaying;
    if (isPlaying) {
        startTime = Date.now();
        animate();
    }
}

function animate() {
    if (!isPlaying) return;

    const elapsed = (Date.now() - startTime) / 1000;
    const totalDuration = editor.data.frames.reduce((sum, scene) => sum + scene.time, 0);
    
    // 循环播放逻辑
    if (elapsed >= totalDuration) {
        startTime = Date.now();
    }
    
    // 计算当前场景
    let accumulated = 0;
    let currentScene;
    for (const scene of editor.data.frames) {
        if (elapsed >= accumulated && elapsed < accumulated + scene.time) {
            currentScene = scene;
            break;
        }
        accumulated += scene.time;
    }

    editor.renderer.render(currentScene || editor.data.frames[0]);
    requestAnimationFrame(animate);
}

function selectObject(id) {
    const obj = editor.currentScene.objects.find(o => o.id === id);
    renderObjectEditor(obj);
}

function renderObjectEditor(obj) {
    const container = document.getElementById('sceneEdit');
    container.innerHTML += `
        <div class="section">
            <h4>对象属性</h4>
            <div class="form-group">
                <label>文本内容：</label>
                <input value="${obj.text}" onchange="updateObjectText(${obj.id}, this.value)">
            </div>
            <div class="form-group">
                <label>X坐标：</label>
                <input type="number" value="${obj.x}" onchange="updateObjectPosition(${obj.id}, 'x', this.value)">
            </div>
            <div class="form-group">
                <label>Y坐标：</label>
                <input type="number" value="${obj.y}" onchange="updateObjectPosition(${obj.id}, 'y', this.value)">
            </div>
            <div class="form-group">
                <label>字体大小：</label>
                <input type="number" value="${obj.size}" onchange="updateObjectProp(${obj.id}, 'size', this.value)">
            </div>
            <div class="form-group">
                <label>颜色：</label>
                <input type="color" value="#${hexColor(obj.color)}" 
                       onchange="updateObjectProp(${obj.id}, 'color', rgbToArray(this.value))">
            </div>
        </div>
    `;
}

// 辅助函数
function hexColor(rgbStr) {
    const rgb = rgbStr.split(',').map(Number);
    return ((rgb[0] << 16) | (rgb[1] << 8) | rgb[2]).toString(16).padStart(6, '0');
}

function rgbToArray(hex) {
    const bigint = parseInt(hex.slice(1), 16);
    return [(bigint >> 16) & 255, (bigint >> 8) & 255, bigint & 255].join(',');
}
function deleteScene(number) {
            if (!confirm("确定要删除这个场景吗？")) return;
            
            editor.deleteScene(number);
            
            // 如果没有任何场景，自动创建新场景
            if (editor.data.frames.length === 0) {
                const newScene = editor.addScene();
                selectScene(newScene.number);
            } else {
                renderSceneList();
                updatePreview();
            }
        }
        class VideoEditor {
            constructor() {
                this.data = {
                    version: "0.0.1",
                    width: 1024,
                    height: 768,
                    rate: 1,
                    frames: []
                };
                this.currentScene = null;
                this.renderer = new VideoRenderer(document.getElementById('previewCanvas'));
                this.initCanvas();
            }

            initCanvas() {
                const canvas = this.renderer.canvas;
                canvas.width = this.data.width;
                canvas.height = this.data.height;
            }
            deleteScene(number) {
                this.data.frames = this.data.frames.filter(s => s.number !== number);
                // 如果删除的是当前场景，切换到第一个场景
                if (this.currentScene?.number === number) {
                    this.currentScene = this.data.frames[0] || null;
                }
            }
            addScene(time = 5) {
                const newScene = {
                    number: Date.now(), // 改用时间戳作为唯一ID
                    time: time,
                    objects: [],
                    backgroundColor: "72,61,139"
                };
                this.data.frames.push(newScene);
                this.currentScene = newScene;
                return newScene;
            }

            getScene(number) {
                return this.data.frames.find(s => s.number === number);
            }

            updateScene(scene) {
                const index = this.data.frames.findIndex(s => s.number === scene.number);
                if (index >= 0) this.data.frames[index] = scene;
            }

            addTextObject(scene, text = "新文本") {
                const newText = {
                    id: Date.now(),
                    text: text,
                    x: 100,
                    y: 100,
                    size: 50,
                    color: "255,255,255"
                };
                scene.objects.push(newText);
                return newText;
            }

            exportJSON() {
                return JSON.stringify(this.data, null, 2);
            }

            importJSON(json) {
                this.data = JSON.parse(json);
                this.initCanvas();
            }
        }

        class VideoRenderer {
            constructor(canvas) {
                this.canvas = canvas;
                this.ctx = canvas.getContext('2d');
                this.ctx.textBaseline = 'top';
            }

            render(scene) {
                this.ctx.clearRect(0, 0, this.canvas.width, this.canvas.height);
                
                // 绘制背景
                this.ctx.fillStyle = `rgb(${scene.backgroundColor})`;
                this.ctx.fillRect(0, 0, this.canvas.width, this.canvas.height);

                // 绘制对象
                scene.objects.forEach(obj => {
                    if (obj.text) {
                        this.ctx.fillStyle = `rgb(${obj.color})`;
                        this.ctx.font = `${obj.size}px Arial`;
                        this.ctx.fillText(obj.text, obj.x, obj.y);
                    }
                });
            }
        }

        // 初始化编辑器实例
        const editor = new VideoEditor();

        // UI操作函数
        function addScene() {
            const scene = editor.addScene();
            renderSceneList();
            selectScene(scene.number);
        }

        function selectScene(number) {
            editor.currentScene = editor.data.frames.find(s => s.number === number);
            renderSceneList();  // 新增这行以刷新列表状态
            renderSceneEditor();
            updatePreview();
        }

        function updateSceneProp(prop, value) {
            editor.currentScene[prop] = isNaN(value) ? value : Number(value);
            renderSceneList();  // 新增场景列表刷新
            updatePreview();
        }

        function addTextObject() {
            editor.addTextObject(editor.currentScene);
            renderSceneEditor();
            updatePreview();
        }

        function renderSceneList() {
            const list = document.getElementById('sceneList');
            list.innerHTML = editor.data.frames.map(scene => `
                <div class="scene-item ${editor.currentScene?.number === scene.number ? 'active' : ''}">
                    <div onclick="selectScene(${scene.number})" style="flex-grow:1;">
                        场景 ${scene.number} (${scene.time}s)
                    </div>
                    <button class="delete-btn" onclick="deleteScene(${scene.number})">×</button>
                </div>
            `).join('');
        }

        function renderSceneEditor() {
            const scene = editor.currentScene;
            const container = document.getElementById('sceneEdit');
            if (!scene) return;

            container.innerHTML = `
                <div class="form-group">
                    <label>持续时间 (秒):</label>
                    <input type="number" value="${scene.time}" 
                        onchange="updateSceneProp('time', this.value)">
                </div>
                <div class="form-group">
                    <label>背景颜色:</label>
                    <input type="color" 
                        value="#${hexColor(scene.backgroundColor)}" 
                        onchange="updateSceneProp('backgroundColor', rgbToArray(this.value))">
                </div>
                <h4>对象列表</h4>
                <div class="object-list">
                    ${scene.objects.map(obj => `
                        <div class="object-item" onclick="selectObject(${obj.id})">
                            ${obj.text}
                        </div>
                    `).join('')}
                </div>
                <button onclick="addTextObject()">添加文本</button>
            `;
        }
        function updatePreview() {
            if (editor.currentScene) {
                editor.renderer.render(editor.currentScene);
            }
        }

        // 数据操作
        function exportJSON() {
            const data = editor.exportJSON();
            const blob = new Blob([data], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'video-project.json';
            a.click();
        }

        function importJSON() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = 'application/json';
            input.onchange = e => {
                const file = e.target.files[0];
                const reader = new FileReader();
                reader.onload = () => {
                    editor.importJSON(reader.result);
                    renderSceneList();
                    selectScene(editor.data.frames[0]?.number);
                };
                reader.readAsText(file);
            };
            input.click();
        }

        // 初始化示例场景
        editor.addScene();
        renderSceneList();
        selectScene(1);
    </script>
</body>
</html>