<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DeepSeek Toolbar</title>
    <script src="js/blDSClass.js"></script>
    <script src="js/blDSMusic.js"></script>
    <style>
        .ds_window {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: #444;
            border-radius: 6px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
            z-index: 1002;
            display: none;
            width: 300px;
            min-height: 200px;
            flex-direction: column;
        }
        
        .ds_window_header {
            background: #333;
            padding: 10px;
            border-radius: 6px 6px 0 0;
            cursor: move;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .ds_window_title {
            color: #fff;
            font-weight: bold;
        }
        
        .ds_window_content {
            flex: 1;
            padding: 10px;
        }
        
        .ds_textarea {
            width: 95%;
            height: 150px;
            background: #555;
            border: 1px solid #666;
            color: #fff;
            padding: 8px;
            border-radius: 4px;
            resize: vertical;
        }
        
        .ds_window_close {
            color: #fff;
            cursor: pointer;
            padding: 0 5px;
        }
        .ds_canvas {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: #f0f0f0;
            z-index: 1;
        }
        .ds_toolbar {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: #333;
            color: #fff;
            padding: 10px;
            z-index: 1000;
            display: flex;
            gap: 10px;
            justify-content: flex-start;
        }
        .ds_button {
            background: #4a5568;
            color: #f1f1f1;
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.2s ease;
            min-width: 60px;
            text-align: center;
            user-select: none;
            position: relative; /* Add positioning context */
        }
        .ds_button:hover {
            background: #2d3748;
            transform: translateY(-1px);
        }
        .ds_menu {
            position: absolute;
            bottom: 100%;
            left: 0;
            background: #444;
            border-radius: 4px;
            padding: 8px;
            display: none;
            flex-direction: column;
            gap: 4px;
            min-width: 150px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
            z-index: 1001;
        }

        .ds_menu.active {
            display: flex;
        }

        .ds_menu_item {
            padding: 8px;
            color: #fff;
            cursor: pointer;
            border-radius: 3px;
        }

        .ds_menu_item:hover {
            background: #555;
        }
    </style>
</head>
<body>
<script>
    class DeepSeekApp {
        constructor() {
            this.styleAdded = false;
            this.addBaseStyles();
        }

        addBaseStyles() {
            if (this.styleAdded) return;
            // 基础样式已移至<head>的style标签
            this.styleAdded = true;
        }

        createCanvas(parentElement, id) {
            const canvas = document.createElement('canvas');
            canvas.id = id;
            canvas.className = 'ds_canvas';
            parentElement.appendChild(canvas);
            
            // 处理高清显示
            const dpr = window.devicePixelRatio || 1;
            const rect = canvas.getBoundingClientRect();
            canvas.width = rect.width * dpr;
            canvas.height = rect.height * dpr;
            canvas.getContext('2d').scale(dpr, dpr);
            
            return canvas;
        }

        createToolbar(parentElement, id) {
            const toolbar = document.createElement('div');
            toolbar.id = id;
            toolbar.className = 'ds_toolbar';
            parentElement.appendChild(toolbar);
            return toolbar;
        }

        addButton(parentElement, id, text) {
            const button = document.createElement('div');
            button.id = id;
            button.className = 'ds_button';
            button.textContent = text;
            parentElement.appendChild(button);
            return button;
        }

        // 节流函数优化性能
        throttle(func, limit = 100) {
            let lastFunc;
            let lastRan;
            return function(...args) {
                if (!lastRan) {
                    func.apply(this, args);
                    lastRan = Date.now();
                } else {
                    clearTimeout(lastFunc);
                    lastFunc = setTimeout(() => {
                        if ((Date.now() - lastRan) >= limit) {
                            func.apply(this, args);
                            lastRan = Date.now();
                        }
                    }, limit - (Date.now() - lastRan));
                }
            };
        }
    }

    // 初始化应用
    const app = new DeepSeekApp();
    const canvas = app.createCanvas(document.body, 'mainCanvas');
    const toolbar = app.createToolbar(document.body, 'mainToolbar');

    const windowBtn = app.addButton(toolbar, 'windowBtn', 'Notes');
    
    // Create movable window
    const movableWindow = document.createElement('div');
    movableWindow.className = 'ds_window';
    
    // Window header
    const windowHeader = document.createElement('div');
    windowHeader.className = 'ds_window_header';
    
    const windowTitle = document.createElement('div');
    windowTitle.className = 'ds_window_title';
    windowTitle.textContent = 'Notes Window';
    
    const windowClose = document.createElement('div');
    windowClose.className = 'ds_window_close';
    windowClose.innerHTML = '&times;';
    
    // Window content
    const windowContent = document.createElement('div');
    windowContent.className = 'ds_window_content';
    const textarea = document.createElement('textarea');
    textarea.className = 'ds_textarea';
    textarea.placeholder = 'Type your notes here...';
    
    // Assemble window
    windowHeader.appendChild(windowTitle);
    windowHeader.appendChild(windowClose);
    movableWindow.appendChild(windowHeader);
    windowContent.appendChild(textarea);
    movableWindow.appendChild(windowContent);
    document.body.appendChild(movableWindow);
    
    // Toggle window visibility
    windowBtn.addEventListener('click', () => {
        const currentDisplay = window.getComputedStyle(movableWindow).display;
        movableWindow.style.display = currentDisplay === 'none' ? 'flex' : 'none';
    });
    
    // Close window
    windowClose.addEventListener('click', () => {
        movableWindow.style.display = 'none';
    });
    
    // Make window draggable
    let isDragging = false;
    let currentX = 0;
    let currentY = 0;
    let initialX = 0;
    let initialY = 0;
    let xOffset = 0;
    let yOffset = 0;
    
    windowHeader.addEventListener('mousedown', dragStart);
    document.addEventListener('mouseup', dragEnd);
    document.addEventListener('mousemove', drag);
    
    // Touch events for mobile
    windowHeader.addEventListener('touchstart', dragStart);
    document.addEventListener('touchend', dragEnd);
    document.addEventListener('touchmove', drag);
    textarea.addEventListener('input', function() {
        const ctx = canvas.getContext('2d');
        // Clear canvas using CSS dimensions to handle HiDPI scaling
        ctx.clearRect(0, 0, canvas.clientWidth, canvas.clientHeight);
        
        // Set text styling
        ctx.fillStyle = '#000000'; // Visible color against light background
        ctx.font = '14px Arial';   // Appropriate font size
        ctx.textBaseline = 'top';  // Align text from the top

        // Split text into lines and draw each line
        const lines = this.value.split('\n');
        lines.forEach((line, index) => {
            //ctx.fillText(line, 20, 20 + index * 20); // 20px line height
            
            const cx = canvas.getContext('2d');
            const ns = line.split(' '); 
            const msc = new CBlDSMusic();
            msc.drawTest(cx,ns,33,54 + index * 20,33);
        });
    });
    function dragStart(e) {
        if (e.type === 'touchstart') {
            initialX = e.touches[0].clientX - xOffset;
            initialY = e.touches[0].clientY - yOffset;
        } else {
            initialX = e.clientX - xOffset;
            initialY = e.clientY - yOffset;
        }
        
        if (e.target === windowHeader) {
            isDragging = true;
        }
    }
    
    function dragEnd(e) {
        initialX = currentX;
        initialY = currentY;
        isDragging = false;
    }
    
    function drag(e) {
        if (isDragging) {
            e.preventDefault();
            
            if (e.type === 'touchmove') {
                currentX = e.touches[0].clientX - initialX;
                currentY = e.touches[0].clientY - initialY;
            } else {
                currentX = e.clientX - initialX;
                currentY = e.clientY - initialY;
            }
            
            xOffset = currentX;
            yOffset = currentY;
            
            setTranslate(currentX, currentY, movableWindow);
        }
    }
    
    function setTranslate(xPos, yPos, el) {
        el.style.transform = `translate(${xPos}px, ${yPos}px)`;
    }


    // 添加按钮
    const menuBtn = app.addButton(toolbar, 'menuBtn', 'Settings');
    const coordDisplay = app.addButton(toolbar, 'coordDisplay', '0:0');
    coordDisplay.onclick = function(e){
        const cx = canvas.getContext('2d');
        const ns = ["1---","2//","3//","4//","1,,","5,","2'","7,,-","2''---"]; 
        const msc = new CBlDSMusic();
        msc.drawTest(cx,ns,33,54,55);
    }
     

    // 优化后的坐标更新处理
    const updateCoordinates = app.throttle((e) => {
        const rect = canvas.getBoundingClientRect();
        const getClientPos = (event) => ({
            x: event.touches ? event.touches[0].clientX : event.clientX,
            y: event.touches ? event.touches[0].clientY : event.clientY
        });

        const pos = getClientPos(e);
        const mouseX = pos.x - rect.left;
        const mouseY = pos.y - rect.top;
        
        coordDisplay.textContent = `${Math.round(mouseX)}:${Math.round(mouseY)}`;
    }, 50);

    // 支持触摸和鼠标事件
    canvas.addEventListener('mousemove', updateCoordinates);
    canvas.addEventListener('touchmove', (e) => {
        e.preventDfault(); // 阻止触摸滚动
        updateCoordinates(e);
    }, { passive: false });

    // 窗口大小调整处理
    window.addEventListener('resize', () => {
        const dpr = window.devicePixelRatio || 1;
        const rect = canvas.getBoundingClientRect();
        canvas.width = rect.width * dpr;
        canvas.height = rect.height * dpr;
        canvas.getContext('2d').scale(dpr, dpr);
    });

    // After creating menuBtn in existing code
    const menu = document.createElement('div');
    menu.className = 'ds_menu';

    // Menu items
    ['DeepSeek Home', 'classEditor', 'Close'].forEach(text => {
        const item = document.createElement('div');
        item.className = 'ds_menu_item';
        item.textContent = text;
        if (text === 'DeepSeek Home') {
            item.addEventListener('click', () => {
                window.location.href = 'https://www.deepseek.com';
                menu.classList.remove('active');
            });
        } 
        else if (text === 'classEditor'){
            item.addEventListener('click', () => {
                window.location.href = 'classEditor';
                menu.classList.remove('active');
            }); 
        }
        else if (text === 'Close') {
            item.addEventListener('click', () => menu.classList.remove('active'));
        }
        
        
        menu.appendChild(item);
    });

    menuBtn.appendChild(menu);

    // Toggle menu
    menuBtn.addEventListener('click', function(e) {
        e.stopPropagation();
        menu.classList.toggle('active');
    });

    // Close menu on outside click
    document.addEventListener('click', (e) => {
        if (!menuBtn.contains(e.target)) {
            menu.classList.remove('active');
        }
    });

    // Close on ESC
    document.addEventListener('keydown', (e) => {
        if (e.key === 'Escape') {
            menu.classList.remove('active');
        }
    });

</script>
</body>
</html>