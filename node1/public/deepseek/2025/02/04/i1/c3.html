<!DOCTYPE html>
<html>
<head>
    <title>è‚¡ç¥¨æ¨¡æ‹Ÿç³»ç»Ÿ</title>
    <style>
        body {
            display: flex;
            margin: 0;
            padding: 20px;
            font-family: Arial, sans-serif;
            background: #f0f2f5;
        }
        .chart-container {
            flex: 1;
            margin-right: 20px;
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        canvas {
            border: 1px solid #e8e8e8;
            margin-top: 20px;
        }
        .controls {
            text-align: center;
            margin: 20px 0;
        }
        button {
            padding: 8px 16px;
            margin: 0 5px;
            background: #1890ff;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }
        button:hover {
            background: #40a9ff;
        }
        .chat-container {
            width: 320px;
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        #chatLog {
            height: 500px;
            overflow-y: auto;
            border: 1px solid #e8e8e8;
            padding: 15px;
            margin-bottom: 15px;
            background: #fafafa;
            border-radius: 4px;
        }
        .message {
            margin: 10px 0;
            padding: 8px 12px;
            border-radius: 15px;
            max-width: 85%;
            word-break: break-word;
        }
        .user-message {
            background: #1890ff;
            color: white;
            margin-left: auto;
        }
        .bot-message {
            background: #f0f0f0;
            border: 1px solid #e8e8e8;
        }
        .chat-input {
            display: flex;
            gap: 10px;
        }
        #chatInput {
            flex: 1;
            padding: 8px;
            border: 1px solid #e8e8e8;
            border-radius: 4px;
        }
        .timestamp {
            font-size: 12px;
            color: #999;
            margin: 4px 0;
        }
    </style>
</head>
<body>
    <!-- åœ¨chart-containerå†…æ·»åŠ äº¤æ˜“é¢æ¿ -->
    <div class="chart-container">
        <div class="controls">
            <button onclick="startSimulation()">â–¶ å¼€å§‹æ¨¡æ‹Ÿ</button>
            <button onclick="stopSimulation()">â¹ åœæ­¢æ¨¡æ‹Ÿ</button>
            <div class="trade-panel">
                <input type="number" id="buyAmount" placeholder="ä¹°å…¥æ•°é‡" min="100" step="100">
                <button onclick="executeBuy()">ğŸ’° ä¹°å…¥</button>
            </div>
        </div>
        <!-- æ·»åŠ æŒä»“ä¿¡æ¯æ˜¾ç¤º -->
        <div class="position-info">
            <h4>ğŸ“¦ æŒä»“ä¿¡æ¯</h4>
            <div class="position-item">
                <span>æŒä»“æ•°é‡ï¼š</span>
                <span id="positionQuantity">0</span>
            </div>
            <div class="position-item">
                <span>å¹³å‡æˆæœ¬ï¼š</span>
                <span id="avgCost">0.00</span>
            </div>
            <div class="position-item">
                <span>å½“å‰å¸‚å€¼ï¼š</span>
                <span id="marketValue">0.00</span>
            </div>
            <div class="position-item">
                <span>æµ®åŠ¨ç›ˆäºï¼š</span>
                <span id="profitLoss">0.00</span>
            </div>
        </div>
        <canvas id="chart"></canvas>
    </div>

    <div class="chat-container">
        <h3>ğŸ’¬ å¯¹è¯è®°å½•</h3>
        <div id="chatLog"></div>
        <div class="chat-input">
            <input type="text" id="chatInput" placeholder="è¾“å…¥æ¶ˆæ¯..." onkeypress="handleKeyPress(event)">
            <button onclick="sendMessage()">å‘é€</button>
        </div>
    </div>

<script>
// åˆå§‹åŒ–ç”»å¸ƒ
const canvas = document.getElementById('chart');
const ctx = canvas.getContext('2d');
canvas.width = 800;
canvas.height = 500;

// ç³»ç»Ÿé…ç½®
const config = {
    candleWidth: 14,
    maxDataPoints: 60,
    padding: { top: 40, right: 40, bottom: 60, left: 60 },
    updateInterval: 1500
};

// æ•°æ®å­˜å‚¨
let data = [];
let simulationInterval;
let currentPrice = 100;
let currentDate = Date.now();

// åœ¨åŸæœ‰ä»£ç åŸºç¡€ä¸Šæ·»åŠ ä»¥ä¸‹å†…å®¹

// äº¤æ˜“ç›¸å…³æ•°æ®
let transactions = []; // äº¤æ˜“è®°å½•
let position = {
    quantity: 0,       // æŒä»“æ•°é‡
    totalCost: 0,      // æ€»æˆæœ¬
    avgPrice: 0        // å¹³å‡æˆæœ¬ä»·
};

// ä¹°å…¥æ“ä½œå‡½æ•°
function executeBuy() {
    const amountInput = document.getElementById('buyAmount');
    const amount = parseInt(amountInput.value);
    
    if (!amount || amount < 100) {
        addSystemMessage('âš ï¸ è¯·è¾“å…¥æœ‰æ•ˆçš„ä¹°å…¥æ•°é‡ï¼ˆæœ€å°‘100è‚¡ï¼‰');
        return;
    }

    const currentPrice = data[data.length-1].close;
    const cost = currentPrice * amount;
    
    // è®°å½•äº¤æ˜“
    transactions.push({
        type: 'buy',
        price: currentPrice,
        quantity: amount,
        timestamp: new Date().toISOString()
    });

    // æ›´æ–°æŒä»“
    position.quantity += amount;
    position.totalCost += cost;
    position.avgPrice = position.totalCost / position.quantity;

    // æ›´æ–°ç•Œé¢
    updatePositionDisplay();
    addMessage(`âœ… æˆåŠŸä¹°å…¥ ${amount} è‚¡ï¼Œæˆäº¤ä»· ${currentPrice.toFixed(2)}`, false);
    amountInput.value = '';
}

// æ›´æ–°æŒä»“æ˜¾ç¤º
function updatePositionDisplay() {
    const currentPrice = data[data.length-1].close;
    const marketValue = position.quantity * currentPrice;
    const profitLoss = marketValue - position.totalCost;
    
    document.getElementById('positionQuantity').textContent = position.quantity;
    document.getElementById('avgCost').textContent = position.avgPrice.toFixed(2);
    document.getElementById('marketValue').textContent = marketValue.toFixed(2);
    
    const profitElement = document.getElementById('profitLoss');
    profitElement.textContent = `${profitLoss.toFixed(2)} (${((profitLoss/position.totalCost)*100).toFixed(2)}%)`;
    profitElement.className = profitLoss >= 0 ? 'profit-positive' : 'profit-negative';
}
// ç”Ÿæˆåˆå§‹æ•°æ®
function generateInitialData() {
    data = [];
    for (let i = 0; i < config.maxDataPoints; i++) {
        data.push(generateCandle());
    }
}

// ç”ŸæˆKçº¿æ•°æ®
function generateCandle() {
    const open = currentPrice;
    const change = (Math.random() - 0.5) * 8 + (Math.random() - 0.5) * 4;
    const close = open + change;
    const high = Math.max(open, close) + Math.random() * 6;
    const low = Math.min(open, close) - Math.random() * 6;
    
    const newCandle = {
        timestamp: currentDate,
        open: open,
        high: high,
        low: low,
        close: close
    };
    
    currentPrice = close;
    currentDate += 86400000;
    return newCandle;
}

// ç»˜åˆ¶Kçº¿å›¾
function drawChart() {
    ctx.clearRect(0, 0, canvas.width, canvas.height);
    
    // è®¡ç®—ä»·æ ¼èŒƒå›´
    const prices = data.flatMap(d => [d.high, d.low]);
    const minPrice = Math.min(...prices);
    const maxPrice = Math.max(...prices);
    const priceRange = maxPrice - minPrice || 1;
    
    // è®¡ç®—ç»˜å›¾åŒºåŸŸ
    const plotWidth = canvas.width - config.padding.left - config.padding.right;
    const plotHeight = canvas.height - config.padding.top - config.padding.bottom;
    
    // ç»˜åˆ¶Kçº¿
    data.forEach((candle, index) => {
        const x = config.padding.left + (index * plotWidth) / (config.maxDataPoints - 1);
        const yHigh = config.padding.top + ((maxPrice - candle.high) / priceRange) * plotHeight;
        const yLow = config.padding.top + ((maxPrice - candle.low) / priceRange) * plotHeight;
        const yOpen = config.padding.top + ((maxPrice - candle.open) / priceRange) * plotHeight;
        const yClose = config.padding.top + ((maxPrice - candle.close) / priceRange) * plotHeight;
        
        // ç»˜åˆ¶å½±çº¿
        ctx.beginPath();
        ctx.moveTo(x, yHigh);
        ctx.lineTo(x, yLow);
        ctx.strokeStyle = candle.close >= candle.open ? '#52c41a' : '#f5222d';
        ctx.stroke();
        
        // ç»˜åˆ¶å®ä½“
        ctx.fillStyle = candle.close >= candle.open ? '#52c41a' : '#f5222d';
        ctx.fillRect(
            x - config.candleWidth/2,
            Math.min(yOpen, yClose),
            config.candleWidth,
            Math.abs(yOpen - yClose)
        );
    });
    
    // ç»˜åˆ¶åæ ‡è½´
    drawAxes(minPrice, maxPrice);
}

// ç»˜åˆ¶åæ ‡è½´
function drawAxes(minPrice, maxPrice) {
    ctx.save();
    ctx.strokeStyle = '#ddd';
    ctx.fillStyle = '#666';
    ctx.font = '12px Arial';
    
    // Yè½´
    ctx.beginPath();
    ctx.moveTo(config.padding.left, config.padding.top);
    ctx.lineTo(config.padding.left, canvas.height - config.padding.bottom);
    ctx.stroke();
    
    // Yè½´æ ‡ç­¾
    const ySteps = 5;
    for (let i = 0; i <= ySteps; i++) {
        const price = minPrice + (maxPrice - minPrice) * (i / ySteps);
        const y = config.padding.top + ((maxPrice - price) / priceRange) * 
                 (canvas.height - config.padding.top - config.padding.bottom);
        
        ctx.fillText(price.toFixed(2), 10, y + 4);
    }
    
    // Xè½´
    ctx.beginPath();
    ctx.moveTo(config.padding.left, canvas.height - config.padding.bottom);
    ctx.lineTo(canvas.width - config.padding.right, canvas.height - config.padding.bottom);
    ctx.stroke();
}

// åœ¨updateDataå‡½æ•°æœ«å°¾æ·»åŠ æŒä»“æ›´æ–°
function updateData() {
    data.shift();
    data.push(generateCandle());
    drawChart();
    if(position.quantity > 0) {
        updatePositionDisplay(); // æ¯æ¬¡æ•°æ®æ›´æ–°æ—¶åˆ·æ–°æŒä»“ä¿¡æ¯
    }
}

// æ¨¡æ‹Ÿæ§åˆ¶
function startSimulation() {
    if (!simulationInterval) {
        simulationInterval = setInterval(updateData, config.updateInterval);
        addSystemMessage('æ¨¡æ‹Ÿå·²å¯åŠ¨');
    }
}

function stopSimulation() {
    clearInterval(simulationInterval);
    simulationInterval = null;
    addSystemMessage('æ¨¡æ‹Ÿå·²åœæ­¢');
}

// å¯¹è¯åŠŸèƒ½
function addSystemMessage(text) {
    addMessage(text, false, true);
}

function addMessage(text, isUser, isSystem = false) {
    const chatLog = document.getElementById('chatLog');
    const timestamp = new Date().toLocaleTimeString();
    
    const timeDiv = document.createElement('div');
    timeDiv.className = 'timestamp';
    timeDiv.textContent = timestamp;
    
    const msgDiv = document.createElement('div');
    msgDiv.className = `message ${isUser ? 'user-message' : 'bot-message'}`;
    msgDiv.textContent = text;
    
    if(isSystem) msgDiv.style.fontStyle = 'italic';
    
    chatLog.appendChild(timeDiv);
    chatLog.appendChild(msgDiv);
    chatLog.scrollTop = chatLog.scrollHeight;
}

function sendMessage() {
    const input = document.getElementById('chatInput');
    const message = input.value.trim();
    
    if(message) {
        addMessage(message, true);
        processMessage(message);
        input.value = '';
    }
}

function handleKeyPress(e) {
    if(e.key === 'Enter') sendMessage();
}

// æ¶ˆæ¯å¤„ç†
function processMessage(message) {
    setTimeout(() => {
        const response = generateResponse(message);
        addMessage(response, false);
    }, 800);
}

function generateResponse(message) {
    const lowerMsg = message.toLowerCase();
    const lastCandle = data[data.length-1];
    
    if(lowerMsg.includes('ä»·')) {
        return `å½“å‰ä»·æ ¼ï¼š${lastCandle.close.toFixed(2)}`;
    }
    if(lowerMsg.includes('è¶‹åŠ¿') || lowerMsg.includes('èµ°åŠ¿')) {
        const change = lastCandle.close - data[data.length-2].close;
        return `æœ€è¿‘è¶‹åŠ¿ï¼š${change >= 0 ? 'ğŸ“ˆ ä¸Šæ¶¨' : 'ğŸ“‰ ä¸‹è·Œ'} ${Math.abs(change).toFixed(2)}`;
    }
    if(lowerMsg.includes('å»ºè®®') || lowerMsg.includes('æ“ä½œ')) {
        const suggestions = [
            'å»ºè®®æŒæœ‰è§‚å¯Ÿ', 
            'å¯ä»¥è€ƒè™‘é€¢ä½ä¹°å…¥',
            'æ³¨æ„é£é™©æ§åˆ¶ï¼Œé€‚å½“å‡ä»“',
            'çŸ­æœŸå¯èƒ½å›è°ƒï¼Œå»ºè®®è§‚æœ›'
        ];
        return suggestions[Math.floor(Math.random()*suggestions.length)];
    }
    return 'æ‚¨çš„æ¶ˆæ¯å·²è®°å½•ï¼Œç¨åå°†ç”±åˆ†æå¸ˆå›å¤';
}

// åˆå§‹åŒ–
generateInitialData();
drawChart();
addSystemMessage('ç³»ç»Ÿåˆå§‹åŒ–å®Œæˆï¼Œæ¬¢è¿ä½¿ç”¨è‚¡ç¥¨æ¨¡æ‹Ÿç³»ç»Ÿï¼');
// åˆå§‹åŒ–æ—¶æ·»åŠ äº¤æ˜“æç¤º
addSystemMessage('è¾“å…¥ä¹°å…¥æ•°é‡ï¼ˆæœ€å°‘100è‚¡ï¼‰åç‚¹å‡»ä¹°å…¥æŒ‰é’®å»ºä»“');
</script>
</body>
</html>