<!DOCTYPE html>
<html lang="en">

<head>
    <!-- 原有head内容保持不变 -->
    <style>
        /* 新增样式 */
        .tool-button.active {
            background-color: #4CAF50;
            color: white;
        }
        #drawing-toolbar {
            z-index: 1000;
            top: 40px; /* 在导航栏下方 */
        }
        #main-canvas {
            z-index: 500;
        }
    </style>
</head>

<body class="bg-gray-100 p-4">
    <script>
        // 新增黑板类
        class C4Blackboard {
            constructor() {
                this.canvas = document.createElement('canvas');
                this.ctx = this.canvas.getContext('2d');
                this.tools = [];
                this.selectedTool = null;
                this.isDrawing = false;
                this.lastX = 0;
                this.lastY = 0;
                
                // 设置画布样式
                this.canvas.id = 'main-canvas';
                this.canvas.style.position = 'fixed';
                this.canvas.style.top = '0';
                this.canvas.style.left = '0';
                this.canvas.style.backgroundColor = '#fff';
                document.body.appendChild(this.canvas);

                // 创建工具栏
                this.toolbar = document.createElement('div');
                this.toolbar.id = 'drawing-toolbar';
                this.toolbar.className = 'fixed top-10 left-0 right-0 bg-gray-100 p-2 flex space-x-2';
                document.body.appendChild(this.toolbar);

                // 初始化事件监听
                this.#initEvents();
                this.#handleResize();
                window.addEventListener('resize', () => this.#handleResize());
            }

            #initEvents() {
                this.canvas.addEventListener('mousedown', (e) => this.#startDrawing(e));
                this.canvas.addEventListener('mousemove', (e) => this.#draw(e));
                this.canvas.addEventListener('mouseup', () => this.#stopDrawing());
                this.canvas.addEventListener('mouseout', () => this.#stopDrawing());
            }

            #handleResize() {
                this.canvas.width = window.innerWidth;
                this.canvas.height = window.innerHeight - 60; // 留出工具栏空间
            }

            #startDrawing(e) {
                if (!this.selectedTool) return;
                
                this.isDrawing = true;
                const rect = this.canvas.getBoundingClientRect();
                [this.lastX, this.lastY] = [e.clientX - rect.left, e.clientY - rect.top];
                this.selectedTool.start(this.ctx, this.lastX, this.lastY);
            }

            #draw(e) {
                if (!this.isDrawing || !this.selectedTool) return;

                const rect = this.canvas.getBoundingClientRect();
                const x = e.clientX - rect.left;
                const y = e.clientY - rect.top;
                
                this.selectedTool.draw(this.ctx, x, y, this.lastX, this.lastY);
                [this.lastX, this.lastY] = [x, y];
            }

            #stopDrawing() {
                this.isDrawing = false;
                if (this.selectedTool) {
                    this.selectedTool.end(this.ctx);
                }
            }

            registerTool(tool) {
                this.tools.push(tool);
                
                // 创建工具按钮
                const btn = document.createElement('button');
                btn.className = 'px-4 py-2 border rounded tool-button';
                btn.innerHTML = tool.icon || tool.name;
                btn.onclick = () => this.#selectTool(tool);
                
                this.toolbar.appendChild(btn);
                if (!this.selectedTool) this.#selectTool(tool);
            }

            #selectTool(tool) {
                this.selectedTool = tool;
                document.querySelectorAll('.tool-button').forEach(btn => 
                    btn.classList.remove('active')
                );
                event.target.classList.add('active');
            }
        }

        // 基础绘图工具类
        class C4DrawingTool {
            constructor(name, icon='✏️') {
                this.name = name;
                this.icon = icon;
            }

            start(ctx, x, y) {
                ctx.beginPath();
                ctx.moveTo(x, y);
                ctx.strokeStyle = '#000';
                ctx.lineWidth = 2;
            }

            draw(ctx, x, y, lastX, lastY) {
                ctx.lineTo(x, y);
                ctx.stroke();
            }

            end(ctx) {
                ctx.closePath();
            }
        }

        // 矩形工具
        class C4RectangleTool extends C4DrawingTool {
            constructor() {
                super('矩形', '⬜');
                this.startX = 0;
                this.startY = 0;
            }

            start(ctx, x, y) {
                this.startX = x;
                this.startY = y;
                ctx.beginPath();
            }

            draw(ctx, x, y) {
                ctx.clearRect(0, 0, ctx.canvas.width, ctx.canvas.height);
                ctx.rect(this.startX, this.startY, x - this.startX, y - this.startY);
                ctx.stroke();
            }
        }

        // 修改主应用类
        class C4MobileDevApp {
            constructor() {
                // 保持原有初始化代码...
                
                // 新增黑板实例
                this.blackboard = new C4Blackboard();
                this.#registerDefaultTools();
            }

            #registerDefaultTools() {
                // 注册默认工具
                this.blackboard.registerTool(new C4DrawingTool('画笔'));
                this.blackboard.registerTool(new C4RectangleTool());
            }
        }

        // 保持其他原有类的代码不变...
    </script>
</body>

</html>