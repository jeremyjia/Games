<!DOCTYPE html>
<html lang="en">

<head>
    <!-- 样式优化 -->
    <style>
        #id_4_togglePluginsWnd {
            background-color: #e2e8f0;
            transition: all 0.2s;
        }
        #id_4_togglePluginsWnd.active {
            background-color: #3B82F6;
            color: white;
            box-shadow: 0 2px 4px rgba(59, 130, 246, 0.3);
        }
        .plugin-item:hover {
            background-color: #f1f5f9;
            transform: translateX(4px);
        }
        .tab-button {
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
        }
    </style>
</head>

<body class="bg-gray-100">
    <script>
        class C4MobileDevApp {
            constructor() {
                this.version = "0.35";  // 版本升级
                // ...其他初始化代码...
            }

            // 优化后的插件窗口切换方法
            blTogglePluginsWindow() {
                this.isPluginsWindowVisible = !this.isPluginsWindowVisible;
                this.pluginsWindow.style.display = this.isPluginsWindowVisible ? 'block' : 'none';
                const btn = document.getElementById('id_4_togglePluginsWnd');
                btn?.classList.toggle('active', this.isPluginsWindowVisible);
            }

            // 提取的通用拖拽处理方法
            #setupDragHandling(element, dragHandle) {
                let isDragging = false;
                let startX, startY, initialX, initialY;

                const handleMove = (x, y) => {
                    const dx = x - startX;
                    const dy = y - startY;
                    element.style.left = `${initialX + dx}px`;
                    element.style.top = `${initialY + dy}px`;
                };

                // 鼠标事件
                dragHandle.addEventListener('mousedown', (e) => {
                    isDragging = true;
                    startX = e.clientX;
                    startY = e.clientY;
                    initialX = element.offsetLeft;
                    initialY = element.offsetTop;
                });

                document.addEventListener('mousemove', (e) => {
                    if (isDragging) handleMove(e.clientX, e.clientY);
                });

                document.addEventListener('mouseup', () => isDragging = false);

                // 触摸事件
                dragHandle.addEventListener('touchstart', (e) => {
                    const touch = e.touches[0];
                    isDragging = true;
                    startX = touch.clientX;
                    startY = touch.clientY;
                    initialX = element.offsetLeft;
                    initialY = element.offsetTop;
                });

                document.addEventListener('touchmove', (e) => {
                    if (isDragging) handleMove(e.touches[0].clientX, e.touches[0].clientY);
                });

                document.addEventListener('touchend', () => isDragging = false);
            }

            // 优化后的插件窗口创建
            #createPluginsWindow() {
                // ...原有结构代码...

                // 使用通用拖拽处理方法
                this.#setupDragHandling(pluginsWindow, dragHandle);

                // 优化安装按钮交互
                installedContent.querySelector('#id_4_add_plugin').addEventListener('click', () => {
                    const code = document.getElementById('id_4_ta_in_sandbox').value.trim();
                    if (!code) return alert('请输入插件代码');
                    
                    this.#addPlugin(code);
                    this.#refreshPluginList();
                    this.blTogglePluginsWindow();
                });

                return pluginsWindow;
            }

            // 增强插件安装方法
            #addPlugin(pliCode) {
                const pluginName = `插件-${this.plis.length + 1}-${Date.now().toString(36)}`;
                const newPlugin = new C4Plugin(
                    pluginName,
                    pliCode,
                    `0.${this.plis.length + 1}.0`
                );
                this.plis.push(newPlugin);
                this.#savePlugins();
                this.#addPluginToUI(newPlugin);
            }

            // 优化状态栏更新
            #updateStatusBarLineCount() {
                const textarea = document.getElementById('id_4_ta_in_sandbox');
                const lineCount = textarea.value.split('\n').length;
                const statusText = `仓库: ${this.currentRepo} | 行数: ${lineCount} | 插件: ${this.plis.length}`;
                
                this.panel.querySelector('.status-bar').innerHTML = `
                    ${statusText}
                    <button id="id_4_togglePluginsWnd" 
                            onclick="app.blTogglePluginsWindow()"
                            class="${this.isPluginsWindowVisible ? 'active' : ''}">
                        ${this.isPluginsWindowVisible ? '▲' : '▼'} 插件管理
                    </button>
                `;
            }
        }

        const app = new C4MobileDevApp();
    </script>
</body>
</html>