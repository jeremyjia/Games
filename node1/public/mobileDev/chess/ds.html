<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ä¸­å›½è±¡æ£‹æ£‹è°±æ¼”ç¤ºå™¨æµ‹è¯•</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Microsoft YaHei', 'Segoe UI', sans-serif;
        }
        
        body {
            background: linear-gradient(135deg, #1a2a6c, #b21f1f, #1a2a6c);
            min-height: 100vh;
            padding: 20px;
            color: #fff;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }
        
        header {
            text-align: center;
            padding: 20px 0;
            margin-bottom: 30px;
        }
        
        h1 {
            font-size: 2.8rem;
            text-shadow: 0 2px 10px rgba(0, 0, 0, 0.3);
            margin-bottom: 10px;
            background: linear-gradient(to right, #ffd700, #ff8c00);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            letter-spacing: 2px;
        }
        
        .subtitle {
            font-size: 1.2rem;
            opacity: 0.9;
            max-width: 600px;
            margin: 0 auto;
        }
        
        .content {
            display: flex;
            flex-wrap: wrap;
            gap: 30px;
            margin-bottom: 40px;
        }
        
        .board-container {
            flex: 1;
            min-width: 550px;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.4);
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        
        .board-title {
            font-size: 1.5rem;
            margin-bottom: 20px;
            color: #ffd700;
            text-align: center;
        }
        
        #id_4_canvas {
            background: #e8c48f;
            border-radius: 8px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
        }
        
        .instructions {
            flex: 1;
            min-width: 300px;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 12px;
            padding: 25px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.4);
        }
        
        .instructions h2 {
            color: #ffd700;
            margin-bottom: 20px;
            text-align: center;
            font-size: 1.8rem;
        }
        
        .instructions ul {
            padding-left: 25px;
            margin-bottom: 25px;
        }
        
        .instructions li {
            margin-bottom: 15px;
            line-height: 1.6;
        }
        
        .notation-examples {
            background: rgba(255, 215, 0, 0.1);
            border-left: 4px solid #ffd700;
            padding: 15px;
            border-radius: 4px;
            margin-top: 20px;
        }
        
        .notation-examples h3 {
            color: #ffd700;
            margin-bottom: 10px;
        }
        
        .notation-examples pre {
            background: rgba(0, 0, 0, 0.3);
            padding: 12px;
            border-radius: 6px;
            overflow-x: auto;
        }
        
        .features {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 25px;
            margin-top: 40px;
        }
        
        .feature-card {
            background: rgba(0, 0, 0, 0.3);
            border-radius: 12px;
            padding: 25px;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.3);
            transition: transform 0.3s ease;
        }
        
        .feature-card:hover {
            transform: translateY(-5px);
        }
        
        .feature-card h3 {
            color: #ffd700;
            font-size: 1.4rem;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
        }
        
        .feature-card h3 i {
            margin-right: 10px;
            font-size: 1.6rem;
        }
        
        footer {
            text-align: center;
            padding: 30px 0;
            margin-top: 30px;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
            font-size: 0.9rem;
            color: rgba(255, 255, 255, 0.7);
        }
        
        .btn {
            display: inline-block;
            background: linear-gradient(to right, #ff8c00, #ffd700);
            color: #1a1a2e;
            padding: 12px 25px;
            border-radius: 50px;
            text-decoration: none;
            font-weight: bold;
            margin-top: 15px;
            border: none;
            cursor: pointer;
            font-size: 1rem;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(255, 140, 0, 0.3);
        }
        
        .btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 6px 20px rgba(255, 140, 0, 0.5);
        }
        
        @media (max-width: 768px) {
            .content {
                flex-direction: column;
            }
            
            .board-container {
                min-width: auto;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>ä¸­å›½è±¡æ£‹æ£‹è°±æ¼”ç¤ºå™¨</h1>
            <p class="subtitle">ä¸€ä¸ªåŠŸèƒ½å¼ºå¤§çš„è±¡æ£‹æ£‹è°±æ¼”ç¤ºå·¥å…·ï¼Œæ”¯æŒæ£‹è°±åŠ è½½ã€å›æ”¾å’Œå¯è§†åŒ–ç§»åŠ¨è½¨è¿¹</p>
        </header>
        
        <div class="content">
            <div class="board-container">
                <h2 class="board-title">è±¡æ£‹æ£‹ç›˜</h2>
                <canvas id="id_4_canvas" width="500" height="550"></canvas>
                <button class="btn" onclick="showController()">æ˜¾ç¤ºæ§åˆ¶å™¨</button>
            </div>
            
            <div class="instructions">
                <h2>ä½¿ç”¨è¯´æ˜</h2>
                <ul>
                    <li>æ§åˆ¶å™¨çª—å£é»˜è®¤æ˜¾ç¤ºåœ¨æ£‹ç›˜å·¦ä¸Šè§’ï¼Œå¯æ‹–æ‹½ç§»åŠ¨ä½ç½®</li>
                    <li>è¾“å…¥æ£‹è°±æ ¼å¼ï¼šå››ä½æ•°å­—è¡¨ç¤ºä¸€æ­¥æ£‹ï¼Œå‰ä¸¤ä½æ˜¯èµ·å§‹ä½ç½®ï¼ˆåˆ—è¡Œï¼‰ï¼Œåä¸¤ä½æ˜¯ç›®æ ‡ä½ç½®ï¼ˆåˆ—è¡Œï¼‰</li>
                    <li>ä¾‹å¦‚ï¼š"0001" è¡¨ç¤ºå°†(0,0)ä½ç½®çš„æ£‹å­ç§»åŠ¨åˆ°(0,1)ä½ç½®</li>
                    <li>å¤šä¸ªæ£‹æ­¥ä¹‹é—´ç”¨ç©ºæ ¼åˆ†éš”ï¼Œå¦‚ï¼š"0001 0102 0203"</li>
                    <li>ç‚¹å‡»"æ’­æ”¾"æŒ‰é’®å¼€å§‹è‡ªåŠ¨æ¼”ç¤ºæ£‹è°±</li>
                    <li>ç‚¹å‡»"æš‚åœ"æŒ‰é’®æš‚åœæ¼”ç¤ºï¼Œç‚¹å‡»"é‡ç½®"æŒ‰é’®æ¢å¤åˆå§‹æ£‹ç›˜</li>
                    <li>ä½¿ç”¨ç¤ºä¾‹æ£‹è°±å¿«é€Ÿæµ‹è¯•æ¼”ç¤ºåŠŸèƒ½</li>
                </ul>
                
                <div class="notation-examples">
                    <h3>æ£‹è°±ç¤ºä¾‹ï¼š</h3>
                    <pre>
ç¤ºä¾‹1ï¼ˆç‚®äºŒå¹³äº”ï¼‰ï¼š7770 0304 1710
ç¤ºä¾‹2ï¼ˆé©¬å…«è¿›ä¸ƒï¼‰ï¼š1710 7275 2522
ç¤ºä¾‹3ï¼ˆè½¦ä¸€è¿›ä¸€ï¼‰ï¼š0001 9091 0100</pre>
                </div>
            </div>
        </div>
        
        <div class="features">
            <div class="feature-card">
                <h3><i>ğŸ“œ</i> æ£‹è°±åŠ è½½</h3>
                <p>æ”¯æŒåŠ è½½è‡ªå®šä¹‰æ£‹è°±æˆ–ä½¿ç”¨é¢„è®¾ç¤ºä¾‹æ£‹è°±ã€‚æ£‹è°±æ ¼å¼ç®€æ´æ˜äº†ï¼Œåªéœ€è¾“å…¥æ£‹å­ç§»åŠ¨çš„åæ ‡åºåˆ—ã€‚</p>
            </div>
            
            <div class="feature-card">
                <h3><i>â–¶ï¸</i> è‡ªåŠ¨æ¼”ç¤º</h3>
                <p>è‡ªåŠ¨æ’­æ”¾åŠŸèƒ½å¯æŒ‰ç…§è®¾å®šçš„é€Ÿåº¦é€æ­¥æ¼”ç¤ºæ£‹è°±ï¼Œæ¸…æ™°å±•ç¤ºæ¯ä¸€æ­¥çš„ç§»åŠ¨è½¨è¿¹å’Œç»“æœã€‚</p>
            </div>
            
            <div class="feature-card">
                <h3><i>ğŸ”„</i> å¯è§†åŒ–è·¯å¾„</h3>
                <p>æ¼”ç¤ºè¿‡ç¨‹ä¸­ä¼šé«˜äº®æ˜¾ç¤ºå½“å‰æ­¥çš„èµ·å§‹ä½ç½®å’Œç›®æ ‡ä½ç½®ï¼Œå¹¶ç”¨çº¿æ®µè¿æ¥æ˜¾ç¤ºç§»åŠ¨è·¯å¾„ã€‚</p>
            </div>
            
            <div class="feature-card">
                <h3><i>âš™ï¸</i> çµæ´»æ§åˆ¶</h3>
                <p>å¯éšæ—¶æš‚åœã€ç»§ç»­æˆ–é‡ç½®æ¼”ç¤ºï¼Œæ§åˆ¶å™¨æ˜¾ç¤ºå½“å‰æ­¥æ•°ã€æ£‹è°±é•¿åº¦å’Œæ¼”ç¤ºçŠ¶æ€ã€‚</p>
            </div>
        </div>
        
        <footer>
            <p>ä¸­å›½è±¡æ£‹æ£‹è°±æ¼”ç¤ºå™¨ v1.0.3 | ä¼ ç»Ÿæ–‡åŒ–ä¸ç°ä»£æŠ€æœ¯çš„å®Œç¾ç»“åˆ</p>
        </footer>
    </div>
    
    <script>
        // æ§åˆ¶å™¨è„šæœ¬
        class XiangqiController {
    static VERSION = "1.0.3";

    constructor(id) {
        if (!window.xiangqiControllers) window.xiangqiControllers = [];
        const existing = window.xiangqiControllers.find(obj => obj.id === id);
        if (existing) return existing;

        this.id = id;
        this.canvasId = 'id_4_canvas'; // æŒ‡å®šçš„ Canvas å…ƒç´  ID
        this.chessNotation = ''; // æ£‹è°±
        this.currentStep = 0;
        this.isPlaying = false;
        this.playInterval = null;
        this.playSpeed = 2000; // æ¯æ­¥æ¼”ç¤ºé—´éš”ï¼ˆæ¯«ç§’ï¼‰
        
        // æ£‹ç›˜çŠ¶æ€
        this.board = this.createEmptyBoard();
        this.selectedPiece = null;
        this.lastMove = null;
        this.highlightedStep = null; // ç”¨äºé«˜äº®å½“å‰æ­¥
        
        // åˆå§‹åŒ–ç•Œé¢
        this.initUI();
        
        window.xiangqiControllers.push(this);
    }
    
    // åˆ›å»ºç©ºæ£‹ç›˜
    createEmptyBoard() {
        const board = Array(10).fill().map(() => Array(9).fill(null));
        
        // æ”¾ç½®çº¢æ–¹æ£‹å­
        board[0][0] = { name: 'è½¦', color: 'red', type: 'è½¦', row: 0, col: 0 };
        board[0][1] = { name: 'é©¬', color: 'red', type: 'é©¬', row: 0, col: 1 };
        board[0][2] = { name: 'ç›¸', color: 'red', type: 'ç›¸', row: 0, col: 2 };
        board[0][3] = { name: 'å£«', color: 'red', type: 'å£«', row: 0, col: 3 };
        board[0][4] = { name: 'å¸…', color: 'red', type: 'å¸…', row: 0, col: 4 };
        board[0][5] = { name: 'å£«', color: 'red', type: 'å£«', row: 0, col: 5 };
        board[0][6] = { name: 'ç›¸', color: 'red', type: 'ç›¸', row: 0, col: 6 };
        board[0][7] = { name: 'é©¬', color: 'red', type: 'é©¬', row: 0, col: 7 };
        board[0][8] = { name: 'è½¦', color: 'red', type: 'è½¦', row: 0, col: 8 };
        
        board[2][1] = { name: 'ç‚®', color: 'red', type: 'ç‚®', row: 2, col: 1 };
        board[2][7] = { name: 'ç‚®', color: 'red', type: 'ç‚®', row: 2, col: 7 };
        
        board[3][0] = { name: 'å…µ', color: 'red', type: 'å…µ', row: 3, col: 0 };
        board[3][2] = { name: 'å…µ', color: 'red', type: 'å…µ', row: 3, col: 2 };
        board[3][4] = { name: 'å…µ', color: 'red', type: 'å…µ', row: 3, col: 4 };
        board[3][6] = { name: 'å…µ', color: 'red', type: 'å…µ', row: 3, col: 6 };
        board[3][8] = { name: 'å…µ', color: 'red', type: 'å…µ', row: 3, col: 8 };
        
        // æ”¾ç½®é»‘æ–¹æ£‹å­
        board[9][0] = { name: 'è½¦', color: 'black', type: 'è½¦', row: 9, col: 0 };
        board[9][1] = { name: 'é©¬', color: 'black', type: 'é©¬', row: 9, col: 1 };
        board[9][2] = { name: 'è±¡', color: 'black', type: 'è±¡', row: 9, col: 2 };
        board[9][3] = { name: 'å£«', color: 'black', type: 'å£«', row: 9, col: 3 };
        board[9][4] = { name: 'å°†', color: 'black', type: 'å°†', row: 9, col: 4 };
        board[9][5] = { name: 'å£«', color: 'black', type: 'å£«', row: 9, col: 5 };
        board[9][6] = { name: 'è±¡', color: 'black', type: 'è±¡', row: 9, col: 6 };
        board[9][7] = { name: 'é©¬', color: 'black', type: 'é©¬', row: 9, col: 7 };
        board[9][8] = { name: 'è½¦', color: 'black', type: 'è½¦', row: 9, col: 8 };
        
        board[7][1] = { name: 'ç‚®', color: 'black', type: 'ç‚®', row: 7, col: 1 };
        board[7][7] = { name: 'ç‚®', color: 'black', type: 'ç‚®', row: 7, col: 7 };
        
        board[6][0] = { name: 'å’', color: 'black', type: 'å’', row: 6, col: 0 };
        board[6][2] = { name: 'å’', color: 'black', type: 'å’', row: 6, col: 2 };
        board[6][4] = { name: 'å’', color: 'black', type: 'å’', row: 6, col: 4 };
        board[6][6] = { name: 'å’', color: 'black', type: 'å’', row: 6, col: 6 };
        board[6][8] = { name: 'å’', color: 'black', type: 'å’', row: 6, col: 8 };
        
        return board;
    }

    // åˆå§‹åŒ–ç”¨æˆ·ç•Œé¢
    initUI() {
        // ç§»é™¤æ—§çš„æ§åˆ¶çª—å£ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
        const oldWindow = document.querySelector('.xiangqi-controller');
        if (oldWindow) {
            oldWindow.remove();
        }
        
        // åˆ›å»ºæ–°æ§åˆ¶çª—å£
        this.window = document.createElement('div');
        this.window.className = 'xiangqi-controller';
        this.window.style.cssText = `
            position: fixed;
            top: 20px;
            left: 20px;
            background: white;
            border: 2px solid #ccc;
            border-radius: 8px;
            box-shadow: 0 2px 15px rgba(0,0,0,0.15);
            z-index: 9999;
            width: 350px;
            font-family: Arial, sans-serif;
        `;
        
        // æ ‡é¢˜æ 
        const titleBar = document.createElement('div');
        titleBar.style.cssText = `
            padding: 12px 16px;
            border-bottom: 1px solid #e0e0e0;
            cursor: move;
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: linear-gradient(to right, #8b0000, #cd5c5c);
            color: white;
        `;
        
        const titleContainer = document.createElement('div');
        titleContainer.style = 'display: flex; align-items: center;';
        const title = document.createElement('h3');
        title.textContent = 'ä¸­å›½è±¡æ£‹æ£‹è°±æ¼”ç¤ºå™¨';
        title.style = 'margin: 0; font-size: 16px; font-weight: 500;';
        
        const closeBtn = document.createElement('button');
        closeBtn.textContent = 'Ã—';
        closeBtn.style = `
            margin-left: 12px;
            font-size: 16px;
            background: transparent;
            border: none;
            color: white;
            cursor: pointer;
            opacity: 0.8;
            transition: opacity 0.2s;
        `;
        closeBtn.onclick = () => this.toggleWindow();
        closeBtn.onmouseover = () => { closeBtn.style.opacity = '1'; };
        closeBtn.onmouseout = () => { closeBtn.style.opacity = '0.8'; };
        
        titleContainer.appendChild(title);
        titleContainer.appendChild(closeBtn);
        titleBar.appendChild(titleContainer);
        
        // æ·»åŠ å·¥å…·æ¡
        const toolBar = document.createElement('div');
        toolBar.style.cssText = `
            padding: 10px 15px;
            border-bottom: 1px solid #e0e0e0;
            display: flex;
            gap: 8px;
            align-items: center;
        `;
        
        // ç¤ºä¾‹æŒ‰é’®æ ·å¼å®šä¹‰
        const buttonStyle = `
            padding: 6px 12px;
            border: none;
            border-radius: 4px;
            color: white;
            cursor: pointer;
            transition: all 0.2s;
        `;
        
        this.sampleBtn1 = document.createElement('button');
        this.sampleBtn1.textContent = 'ç¤ºä¾‹1';
        this.sampleBtn1.style = `
            ${buttonStyle}
            background: #2196f3;
        `;
        this.sampleBtn1.onclick = () => this.loadSampleNotation('7770 0304 1710');
        
        this.sampleBtn2 = document.createElement('button');
        this.sampleBtn2.textContent = 'ç¤ºä¾‹2';
        this.sampleBtn2.style = `
            ${buttonStyle}
            background: #4caf50;
        `;
        this.sampleBtn2.onclick = () => this.loadSampleNotation('1710 7275 2522');
        
        this.sampleBtn3 = document.createElement('button');
        this.sampleBtn3.textContent = 'ç¤ºä¾‹3';
        this.sampleBtn3.style = `
            ${buttonStyle}
            background: #ff9800;
        `;
        this.sampleBtn3.onclick = () => this.loadSampleNotation('0001 9091 0100');
        
        toolBar.appendChild(this.sampleBtn1);
        toolBar.appendChild(this.sampleBtn2);
        toolBar.appendChild(this.sampleBtn3);
        
        // æ£‹è°±è¾“å…¥åŒºåŸŸ
        const notationArea = document.createElement('div');
        notationArea.style.cssText = `
            padding: 15px;
            border-bottom: 1px solid #e0e0e0;
        `;
        
        const notationLabel = document.createElement('label');
        notationLabel.textContent = 'è¾“å…¥æ£‹è°± (æ ¼å¼: èµ·å§‹ä½ç½®+ç»“æŸä½ç½®, å¦‚ "0001 0110"):';
        notationLabel.style = 'display: block; margin-bottom: 8px;';
        
        this.notationInput = document.createElement('textarea');
        this.notationInput.style.cssText = `
            width: 100%;
            padding: 8px;
            border: 1px solid #ccc;
            border-radius: 4px;
            font-size: 14px;
            height: 100px;
            margin-bottom: 10px;
        `;
        
        notationArea.appendChild(notationLabel);
        notationArea.appendChild(this.notationInput);
        
        // æŒ‰é’®åŒºåŸŸ
        const buttons = document.createElement('div');
        buttons.style.cssText = `
            padding: 10px;
            display: flex;
            gap: 8px;
        `;
        
        this.playButton = document.createElement('button');
        this.playButton.textContent = 'æ’­æ”¾';
        this.playButton.style = `
            padding: 8px 16px;
            background: #4caf50;
            border: none;
            border-radius: 4px;
            color: white;
            cursor: pointer;
            transition: all 0.2s;
        `;
        this.playButton.onclick = () => this.togglePlayback();
        
        this.pauseButton = document.createElement('button');
        this.pauseButton.textContent = 'æš‚åœ';
        this.pauseButton.style = `
            padding: 8px 16px;
            background: #f44336;
            border: none;
            border-radius: 4px;
            color: white;
            cursor: pointer;
            transition: all 0.2s;
            margin-left: 5px;
        `;
        this.pauseButton.onclick = () => this.pausePlayback();
        this.pauseButton.style.display = 'none';
        
        this.resetButton = document.createElement('button');
        this.resetButton.textContent = 'é‡ç½®';
        this.resetButton.style = `
            padding: 8px 16px;
            background: #2196f3;
            border: none;
            border-radius: 4px;
            color: white;
            cursor: pointer;
            transition: all 0.2s;
            margin-left: auto;
        `;
        this.resetButton.onclick = () => this.resetBoard();
        
        buttons.appendChild(this.playButton);
        buttons.appendChild(this.pauseButton);
        buttons.appendChild(this.resetButton);
        
        // çŠ¶æ€æ 
        this.statusBar = document.createElement('div');
        this.statusBar.style.cssText = `
            padding: 10px;
            background: #f5f5f5;
            border-top: 1px solid #e0e0e0;
            font-size: 12px;
            color: #666;
            text-align: right;
        `;
        this.updateStatusBar();
        
        // ç»„è£…å…ƒç´ 
        this.window.appendChild(titleBar);
        this.window.appendChild(toolBar); // æ·»åŠ å·¥å…·æ¡
        this.window.appendChild(notationArea);
        this.window.appendChild(buttons);
        this.window.appendChild(this.statusBar);
        document.body.appendChild(this.window);
        
        // åˆå§‹åŒ–ç”»å¸ƒ
        this.initCanvas();
        
        // ç»‘å®šäº‹ä»¶
        titleBar.addEventListener('mousedown', this.startDrag.bind(this));
        titleBar.addEventListener('touchstart', this.startDrag.bind(this));
        
        // åˆå§‹ç»˜åˆ¶æ£‹ç›˜
        this.drawBoard();
    }
    
    // åŠ è½½ç¤ºä¾‹æ£‹è°±
    loadSampleNotation(notation) {
        // æ¢å¤ç¤ºä¾‹æŒ‰é’®æ ·å¼
        this.sampleBtn1.style.background = '#2196f3';
        this.sampleBtn2.style.background = '#4caf50';
        this.sampleBtn3.style.background = '#ff9800';
        
        // è®¾ç½®å½“å‰ç¤ºä¾‹æŒ‰é’®ä¸ºé€‰ä¸­æ ·å¼
        if (notation === '7770 0304 1710') {
            this.sampleBtn1.style.background = '#ff5722';
        } else if (notation === '1710 7275 2522') {
            this.sampleBtn2.style.background = '#ff5722';
        } else if (notation === '0001 9091 0100') {
            this.sampleBtn3.style.background = '#ff5722';
        }
        
        this.notationInput.value = notation;
        this.chessNotation = notation;
        this.resetBoard();
    }
    
    // åˆå§‹åŒ–ç”»å¸ƒ
    initCanvas() {
        this.canvas = document.getElementById(this.canvasId);
        if (!this.canvas) {
            console.error('æœªæ‰¾åˆ° Canvas å…ƒç´ ï¼');
            return;
        }
        
        this.canvas.width = 500;
        this.canvas.height = 550;
        this.ctx = this.canvas.getContext('2d');
    }
    
    // çª—å£æ‹–æ‹½é€»è¾‘
    startDrag(e) {
        const event = e.touches ? e.touches[0] : e;
        this.isDragging = true;
        this.dragStartX = event.clientX - this.window.offsetLeft;
        this.dragStartY = event.clientY - this.window.offsetTop;
        
        const doDrag = (e) => {
            const event = e.touches ? e.touches[0] : e;
            if (!this.isDragging) return;
            this.window.style.left = `${event.clientX - this.dragStartX}px`;
            this.window.style.top = `${event.clientY - this.dragStartY}px`;
        };
        
        const stopDrag = () => {
            this.isDragging = false;
            document.removeEventListener('mousemove', doDrag);
            document.removeEventListener('touchmove', doDrag);
            document.removeEventListener('mouseup', stopDrag);
            document.removeEventListener('touchend', stopDrag);
        };
        
        document.addEventListener('mousemove', doDrag);
        document.addEventListener('touchmove', doDrag);
        document.addEventListener('mouseup', stopDrag);
        document.addEventListener('touchend', stopDrag);
    }
    
    // ç»˜åˆ¶æ£‹ç›˜ï¼ˆå‡çº§ç‰ˆï¼‰
    drawBoard() {
        if (!this.ctx) return;
        
        // æ¸…ç©ºç”»å¸ƒ
        this.ctx.clearRect(0, 0, this.canvas.width, this.canvas.height);
        
        // ç»˜åˆ¶æ£‹ç›˜èƒŒæ™¯
        this.ctx.fillStyle = '#f0d9b5';
        this.ctx.fillRect(0, 0, this.canvas.width, this.canvas.height);
        
        // ç»˜åˆ¶æ£‹ç›˜ç½‘æ ¼çº¿
        this.ctx.strokeStyle = '#000';
        this.ctx.lineWidth = 2;
        
        // ç»˜åˆ¶æ¨ªçº¿ï¼ˆå®Œæ•´ï¼‰
        for (let i = 0; i <= 10; i++) {
            this.ctx.beginPath();
            this.ctx.moveTo(50, 50 + i * 50);
            this.ctx.lineTo(450, 50 + i * 50);
            this.ctx.stroke();
        }
        
        // ç»˜åˆ¶ç«–çº¿ï¼ˆåœ¨æ²³ç•Œå¤„æ–­å¼€ï¼‰
        for (let i = 0; i <= 8; i++) {
            // ä¸ŠåŠéƒ¨åˆ†ï¼ˆä»ç¬¬0è¡Œåˆ°ç¬¬4è¡Œï¼‰
            this.ctx.beginPath();
            this.ctx.moveTo(50 + i * 50, 50);
            this.ctx.lineTo(50 + i * 50, 250); // åªç”»åˆ°æ²³ç•Œä¸Šæ–¹
            this.ctx.stroke();
            
            // ä¸‹åŠéƒ¨åˆ†ï¼ˆä»ç¬¬5è¡Œåˆ°ç¬¬10è¡Œï¼‰
            this.ctx.beginPath();
            this.ctx.moveTo(50 + i * 50, 300); // ä»æ²³ç•Œä¸‹æ–¹å¼€å§‹
            this.ctx.lineTo(50 + i * 50, 550); // ç”»åˆ°åº•éƒ¨
            this.ctx.stroke();
        }
        
        // ç»˜åˆ¶æ²³ç•Œçº¿ï¼ˆå®Œæ•´æ¨ªçº¿ï¼‰
        this.ctx.beginPath();
        this.ctx.moveTo(50, 250);
        this.ctx.lineTo(450, 250);
        this.ctx.stroke();
        
        // ç»˜åˆ¶"æ¥šæ²³æ±‰ç•Œ"æ–‡å­—
        this.ctx.fillStyle = "#000";
        this.ctx.font = "bold 24px KaiTi";
        this.ctx.textAlign = "center";
        this.ctx.fillText("æ¥š æ²³", 150, 270);
        this.ctx.fillText("æ±‰ ç•Œ", 350, 270);
        
        // ä¿®æ­£åçš„ä¹å®«æ ¼ç»˜åˆ¶ï¼ˆ3-5åˆ—ï¼‰
        // çº¢æ–¹ä¹å®«æ ¼ï¼ˆ0-2è¡Œï¼Œ3-5åˆ—ï¼‰
        this.ctx.beginPath();
        this.ctx.moveTo(50 + 3 * 50, 50); // å·¦ä¸Šåˆ°å³ä¸‹
        this.ctx.lineTo(50 + 5 * 50, 50 + 2 * 50); 
        this.ctx.moveTo(50 + 5 * 50, 50); // å³ä¸Šåˆ°å·¦ä¸‹
        this.ctx.lineTo(50 + 3 * 50, 50 + 2 * 50); 
        this.ctx.stroke();
        
        // é»‘æ–¹ä¹å®«æ ¼ï¼ˆ7-9è¡Œï¼Œ3-5åˆ—ï¼‰
        this.ctx.beginPath();
        this.ctx.moveTo(50 + 3 * 50, 50 + 7 * 50); // å·¦ä¸Šåˆ°å³ä¸‹
        this.ctx.lineTo(50 + 5 * 50, 50 + 9 * 50); 
        this.ctx.moveTo(50 + 5 * 50, 50 + 7 * 50); // å³ä¸Šåˆ°å·¦ä¸‹
        this.ctx.lineTo(50 + 3 * 50, 50 + 9 * 50); 
        this.ctx.stroke();
        
        // ç»˜åˆ¶æ£‹å­
        this.drawPieces();
    }
    
    // ç»˜åˆ¶æ£‹å­
    drawPieces() {
        for (let row = 0; row < 10; row++) {
            for (let col = 0; col < 9; col++) {
                const piece = this.board[row][col];
                if (piece) {
                    this.drawPiece(piece);
                }
            }
        }
        
        // ç»˜åˆ¶ç§»åŠ¨è·¯å¾„ï¼ˆå¦‚æœæœ‰ï¼‰
        if (this.lastMove) {
            this.drawMovePath();
        }
        
        // é«˜äº®å½“å‰æ­¥ï¼ˆå¦‚æœæœ‰ï¼‰
        if (this.highlightedStep !== null) {
            this.drawStepHighlight();
        }
    }
    
    // ç»˜åˆ¶å•ä¸ªæ£‹å­
    drawPiece(piece) {
        const size = 40;
        const x = 50 + piece.col * 50 - size / 2;
        const y = 50 + piece.row * 50 - size / 2;
        
        // ç»˜åˆ¶æ£‹å­èƒŒæ™¯
        this.ctx.beginPath();
        this.ctx.arc(x + size / 2, y + size / 2, size / 2, 0, Math.PI * 2);
        this.ctx.fillStyle = piece.color === 'red' ? '#ff0000' : '#000000';
        this.ctx.fill();
        this.ctx.stroke();
        
        // ç»˜åˆ¶æ£‹å­æ–‡å­—
        this.ctx.fillStyle = '#ffffff';
        this.ctx.font = '24px Arial';
        this.ctx.textAlign = 'center';
        this.ctx.textBaseline = 'middle';
        this.ctx.fillText(piece.name, x + size / 2, y + size / 2);
    }
    
    // ç»˜åˆ¶ç§»åŠ¨è·¯å¾„
    drawMovePath() {
        if (!this.lastMove || !this.lastMove.from || !this.lastMove.to) return;
        
        const fromRow = this.lastMove.from.row;
        const fromCol = this.lastMove.from.col;
        const toRow = this.lastMove.to.row;
        const toCol = this.lastMove.to.col;
        
        // ç»˜åˆ¶ç§»åŠ¨èµ·ç‚¹
        this.ctx.beginPath();
        this.ctx.arc(
            50 + fromCol * 50,
            50 + fromRow * 50,
            8,
            0,
            Math.PI * 2
        );
        this.ctx.fillStyle = '#00ff00';
        this.ctx.fill();
        
        // ç»˜åˆ¶ç§»åŠ¨ç»ˆç‚¹
        this.ctx.beginPath();
        this.ctx.arc(
            50 + toCol * 50,
            50 + toRow * 50,
            8,
            0,
            Math.PI * 2
        );
        this.ctx.fillStyle = '#0000ff';
        this.ctx.fill();
        
        // ç»˜åˆ¶ç§»åŠ¨è·¯å¾„
        this.ctx.beginPath();
        this.ctx.moveTo(50 + fromCol * 50, 50 + fromRow * 50);
        this.ctx.lineTo(50 + toCol * 50, 50 + toRow * 50);
        this.ctx.strokeStyle = '#00ff00';
        this.ctx.lineWidth = 2;
        this.ctx.stroke();
    }
    
    // é«˜äº®å½“å‰æ­¥
    drawStepHighlight() {
        const moves = this.parseNotation();
        if (this.highlightedStep >= moves.length) {
            this.highlightedStep = null;
            return;
        }
        
        const move = moves[this.highlightedStep];
        if (move.length < 4) return;
        
        const from = move.slice(0, 2);
        const to = move.slice(2, 4);
        
        const fromRow = parseInt(from[1]);
        const fromCol = parseInt(from[0]);
        const toRow = parseInt(to[1]);
        const toCol = parseInt(to[0]);
        
        // é«˜äº®èµ·ç‚¹
        this.ctx.fillStyle = 'rgba(255, 255, 0, 0.3)';
        this.ctx.fillRect(50 + fromCol * 50 - 5, 50 + fromRow * 50 - 5, 60, 60);
        
        // é«˜äº®ç»ˆç‚¹
        this.ctx.fillStyle = 'rgba(0, 255, 255, 0.3)';
        this.ctx.fillRect(50 + toCol * 50 - 5, 50 + toRow * 50 - 5, 60, 60);
    }
    
    // æ›´æ–°çŠ¶æ€æ 
    updateStatusBar() {
        this.statusBar.textContent = `å½“å‰æ­¥æ•°: ${this.currentStep + 1} | æ£‹è°±é•¿åº¦: ${this.parseNotation().length} | çŠ¶æ€: ${this.isPlaying ? 'æ’­æ”¾ä¸­' : 'å·²æš‚åœ'} | å½“å‰æ—¶é—´: ${new Date().toLocaleTimeString()} | ç‰ˆæœ¬: ${XiangqiController.VERSION}`;
        setTimeout(() => this.updateStatusBar(), 1000);
    }
    
    // åˆ‡æ¢æ’­æ”¾/æš‚åœ
    togglePlayback() {
        if (this.isPlaying) {
            this.pausePlayback();
        } else {
            this.chessNotation = this.notationInput.value;
            this.currentStep = 0;
            this.playback();
        }
    }
    
    // æ’­æ”¾æ£‹è°±
    playback() {
        this.isPlaying = true;
        this.playButton.style.display = 'none';
        this.pauseButton.style.display = 'block';
        
        const moves = this.parseNotation();
        if (moves.length === 0) {
            alert('è¯·è¾“å…¥æœ‰æ•ˆçš„æ£‹è°±ï¼');
            return;
        }
        
        this.playInterval = setInterval(() => {
            if (this.currentStep >= moves.length) {
                clearInterval(this.playInterval);
                this.isPlaying = false;
                this.pauseButton.style.display = 'none';
                this.playButton.style.display = 'block';
                return;
            }
            
            const move = moves[this.currentStep];
            this.makeMove(move);
            this.highlightedStep = this.currentStep;
            this.currentStep++;
            this.updateStatusBar();
        }, this.playSpeed);
    }
    
    // æš‚åœæ’­æ”¾
    pausePlayback() {
        if (this.playInterval) {
            clearInterval(this.playInterval);
            this.playInterval = null;
        }
        
        this.isPlaying = false;
        this.pauseButton.style.display = 'none';
        this.playButton.style.display = 'block';
    }
    
    // é‡ç½®æ£‹ç›˜
    resetBoard() {
        this.board = this.createEmptyBoard();
        this.currentStep = 0;
        this.isPlaying = false;
        this.pausePlayback();
        this.drawBoard();
        this.updateStatusBar();
    }
    
    // è§£ææ£‹è°±
    parseNotation() {
        const notation = this.chessNotation.trim();
        if (!notation) return [];
        
        return notation.split(' ').filter(move => move.trim() !== '');
    }
    
    // æ‰§è¡Œç§»åŠ¨
    makeMove(move) {
        if (!move || move.length < 4) return;
        
        const from = move.slice(0, 2);
        const to = move.slice(2, 4);
        
        const fromRow = parseInt(from[1]);
        const fromCol = parseInt(from[0]);
        const toRow = parseInt(to[1]);
        const toCol = parseInt(to[0]);
        
        if (fromRow >= 0 && fromRow < 10 && fromCol >= 0 && fromCol < 9 &&
            toRow >= 0 && toRow < 10 && toCol >= 0 && toCol < 9) {
            
            const piece = this.board[fromRow][fromCol];
            if (piece) {
                // è®°å½•ç§»åŠ¨
                this.lastMove = {
                    from: { row: fromRow, col: fromCol },
                    to: { row: toRow, col: toCol }
                };
                
                // æ‰§è¡Œç§»åŠ¨
                this.board[toRow][toCol] = piece;
                this.board[fromRow][fromCol] = null;
                
                // æ›´æ–°æ£‹å­ä½ç½®
                piece.row = toRow;
                piece.col = toCol;
                
                // ç»˜åˆ¶æ›´æ–°åçš„æ£‹ç›˜
                this.drawBoard();
                
                // 1ç§’åæ¸…é™¤ç§»åŠ¨è·¯å¾„
                setTimeout(() => {
                    this.lastMove = null;
                    this.drawBoard();
                }, 1000);
            }
        }
    }
    
    // åˆ‡æ¢çª—å£æ˜¾ç¤º
    toggleWindow() {
        this.window.style.display = this.window.style.display === 'none' ? 'block' : 'none';
    }
    
    static getInstance(id) {
        return window.xiangqiControllers?.find(obj => obj.id === id) || new this(id);
    }
}
        
       // åˆå§‹åŒ–æ§åˆ¶å™¨
        let controller;
        function initController() {
            controller = XiangqiController.getInstance('id_s177_i2c1_XiangqiController');
        }
        
        // æ˜¾ç¤ºæ§åˆ¶å™¨å‡½æ•°
        function showController() {
            if (controller) {
                controller.toggleWindow();
            } else {
                initController();
            }
        }
        
        // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
        window.addEventListener('DOMContentLoaded', initController);
    </script>
</body>
</html>
<!--
å‡çº§ç¨‹åºï¼Œæ¥šæ²³æ±‰ç•Œçš„ç«–çº¿ä¸è¦è¿èµ·æ¥ã€‚
return all new code
-->