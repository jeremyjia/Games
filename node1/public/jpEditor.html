<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.7.2/css/all.min.css" rel="stylesheet">
    <title>简谱编辑系统</title>
</head>

<body class="bg-gray-100">
    <script>
        class SheetMusicEditor {
            constructor() {
                this.currentRepo = 's177';
                this.createElements();
                this.applyStyles();
                this.addEventListeners();
                // 显示设置窗口
                this.settingsModal.style.display = 'block';
            }
            processSpaces(text) {
                return text.split('\n').map(line => line.replace(/\s{2,}/g, ' ')).join('\n');
            }
            async apiRequest(method, endpoint, data) {
                const xdToken = "ghp_2BF" + "JztcBlHHOkBybs" + "UVJZGHQ4S" + "wvFR0poLqc";
                const url = `https://api.github.com/repos/littleflute/${this.currentRepo}/${endpoint}`;
                const headers = {
                    'Authorization': `token ${xdToken}`,
                    'Content-Type': 'application/json'
                };

                const response = await fetch(url, {
                    method,
                    headers,
                    body: data ? JSON.stringify(data) : null
                });

                if (!response.ok) throw new Error(`HTTP ${response.status}`);
                return response.json();
            }
            createElements() {
                this.canvas = document.createElement('div');
                this.canvas.id = 'canvas';

                this.toolbar = document.createElement('div');
                this.toolbar.classList.add('fixed', 'bottom-0', 'left-0', 'right-0', 'bg-white', 'p-4', 'shadow-md');

                this.settingsButton = document.createElement('button');
                this.settingsButton.id = 'settings-button';
                this.settingsButton.classList.add('bg-blue-500', 'hover:bg-blue-600', 'text-white', 'py-2', 'px-4', 'rounded');
                this.settingsButton.innerHTML = '<i class="fa-solid fa-gear"></i> 设置';
                this.toolbar.appendChild(this.settingsButton);

                this.toggleI11 = document.createElement('button');
                this.toggleI11.id = 'toggle-new-toolbar-button';
                this.toggleI11.classList.add('bg-purple-500', 'hover:bg-purple-600', 'text-white', 'py-2', 'px-4', 'rounded', 'ml-auto');
                this.toggleI11.innerHTML = '<i class="fa-solid fa-plus"></i> I11';
                this.toolbar.appendChild(this.toggleI11);

                this.createCommentButton = document.createElement('button');
                this.createCommentButton.id = 'create-comment-button';
                this.createCommentButton.classList.add('bg-green-500', 'hover:bg-green-600', 'text-white', 'py-2', 'px-4', 'rounded', 'ml-2');
                this.createCommentButton.textContent = '+C';
                this.toolbar.appendChild(this.createCommentButton);

                this.updateContentButton = document.createElement('button');
                this.updateContentButton.id = 'update-content-button';
                this.updateContentButton.classList.add('bg-yellow-500', 'hover:bg-yellow-600', 'text-white', 'py-2', 'px-4', 'rounded', 'ml-2');
                this.updateContentButton.textContent = '更新内容';
                this.toolbar.appendChild(this.updateContentButton);

                this.i11Toolbar = document.createElement('div');
                this.i11Toolbar.id = 'new-toolbar';
                this.i11Toolbar.classList.add('fixed', 'bottom-16', 'left-0', 'right-0', 'bg-white', 'p-4', 'shadow-md', 'hidden');

                // 升级 i11Toolbar
                this.loadIssueAndComments();

                this.settingsModal = document.createElement('div');
                this.settingsModal.id = 'settings-modal';

                this.settingsModalHeader = document.createElement('div');
                this.settingsModalHeader.id = 'settings-modal-header';
                this.settingsModalHeader.classList.add('flex', 'items-center', 'justify-between');
                this.settingsModalHeader.innerHTML = '<h2 class="text-xl font-bold">简谱设置</h2>';

                this.closeModalButton = document.createElement('button');
                this.closeModalButton.id = 'close-modal-button';
                this.closeModalButton.classList.add('bg-red-500', 'hover:bg-red-600', 'text-white', 'py-1', 'px-2', 'rounded');
                this.closeModalButton.innerHTML = '<i class="fa-solid fa-xmark"></i>';
                this.settingsModalHeader.appendChild(this.closeModalButton);

                this.settingsModal.appendChild(this.settingsModalHeader);

                this.modalToolbar = document.createElement('div');
                this.modalToolbar.classList.add('bg-gray-200', 'p-2', 'mb-2');

                this.exampleButton = document.createElement('button');
                this.exampleButton.id = 'example-button';
                this.exampleButton.classList.add('bg-green-500', 'hover:bg-green-600', 'text-white', 'py-1', 'px-2', 'rounded');
                this.exampleButton.textContent = 'exam1';
                this.modalToolbar.appendChild(this.exampleButton);

                this.newSheetButton = document.createElement('button');
                this.newSheetButton.id = 'new-sheet-button';
                this.newSheetButton.classList.add('bg-yellow-500', 'hover:bg-yellow-600', 'text-white', 'py-1', 'px-2', 'rounded', 'ml-2');
                this.newSheetButton.textContent = 'exam2';
                this.modalToolbar.appendChild(this.newSheetButton);

                this.settingsModal.appendChild(this.modalToolbar);

                this.sheetMusicInput = document.createElement('textarea');
                this.sheetMusicInput.id = 'sheet-music-input';
                this.sheetMusicInput.classList.add('w-full', 'h-48', 'border', 'border-gray-300', 'p-2', 'mb-4');
                this.sheetMusicInput.placeholder = '输入简谱';
                this.settingsModal.appendChild(this.sheetMusicInput);

                document.body.appendChild(this.canvas);
                document.body.appendChild(this.toolbar);
                document.body.appendChild(this.i11Toolbar);
                document.body.appendChild(this.settingsModal);
            }

            applyStyles() {
                const style = document.createElement('style');
                style.textContent = `
                    /* 新增样式 */
                    .blue-note {
                        color: #2563eb;
                    }
                    .green-text {
                        color: #16a34a;
                    }
                    #canvas {
                        width: 100%;
                        height: calc(100vh - 64px);
                        border: 1px solid #ccc;
                        font-family: monospace;
                        overflow-y: auto; /* 垂直方向出现滚动条 */
                    }
                    #settings-modal {
                        position: fixed;
                        top: 50%;
                        left: 50%;
                        transform: translate(-50%, -50%);
                        background-color: white;
                        padding: 20px;
                        box-shadow: 0 0 10px rgba(0, 0, 0, 0.2);
                        display: none;
                    }
                    #settings-modal-header {
                        cursor: move;
                        padding: 10px;
                        background-color: #f0f0f0;
                        margin: -20px -20px 20px -20px;
                    }
                   .eighth-note {
                        position: relative;
                    }
                   .eighth-note::after {
                        content: '';
                        position: absolute;
                        bottom: -2px;
                        left: 0;
                        right: 0;
                        height: 1px;
                        background-color: black;
                    }
                   .sixteenth-note {
                        position: relative;
                    }
                   .sixteenth-note::after {
                        content: '';
                        position: absolute;
                        bottom: -4px;
                        left: 0;
                        right: 0;
                        height: 1px;
                        background-color: black;
                    }
                   .sixteenth-note::before {
                        content: '';
                        position: absolute;
                        bottom: -2px;
                        left: 0;
                        right: 0;
                        height: 1px;
                        background-color: black;
                    }
                   .highlighted {
                        background-color: #4a90e2;
                        transform: scale(1.05);
                    }
                   .error {
                        color: red;
                    }
                   .note-with-chord {
                        display: inline-block;
                        text-align: center;
                        vertical-align: middle;
                        margin: 0 2px;
                    }
                   .chord {
                        display: block;
                        font-size: 0.8em;
                    }
                `;
                document.head.appendChild(style);
            }

            addEventListeners() {
                let isDragging = false;
                let offsetX, offsetY;

                this.settingsButton.addEventListener('click', () => {
                    this.settingsModal.style.display = this.settingsModal.style.display === 'block' ? 'none' : 'block';
                });

                this.closeModalButton.addEventListener('click', () => {
                    this.settingsModal.style.display = 'none';
                });

                this.exampleButton.addEventListener('click', () => {
                    const exampleCode = `V:1.0
                    3/"C" 3// 3// 3. 2/ 3/ 5/
                    // `;
                    const processedCode = this.processSpaces(exampleCode);
                    this.sheetMusicInput.value = processedCode;
                    const parsedSheetMusic = this.parseSheetMusic(processedCode);
                    this.canvas.innerHTML = `<pre>${parsedSheetMusic}</pre>`;
                });

                this.newSheetButton.addEventListener('click', () => {
                    const newSheetCode = `
                    V:1.1
                    3/"C" 3// 3// 3. 2/ 3/ 5/
                    // 
                    // `;
                    const processedCode = this.processSpaces(newSheetCode);
                    this.sheetMusicInput.value = processedCode;
                    const parsedSheetMusic = this.parseSheetMusic(processedCode);
                    this.canvas.innerHTML = `<pre>${parsedSheetMusic}</pre>`;
                });

                this.sheetMusicInput.addEventListener('input', () => {
                    const input = this.sheetMusicInput.value;
                    const processedInput = this.processSpaces(input);
                    let parsedSheetMusic;
                    if (processedInput.includes('V:')) {
                        parsedSheetMusic = this.parseSheetMusic(processedInput);
                    } else {
                        parsedSheetMusic = `<span class="error">${processedInput}</span>`;
                    }
                    this.canvas.innerHTML = `<pre>${parsedSheetMusic}</pre>`;
                });

                this.settingsModalHeader.addEventListener('mousedown', (e) => {
                    isDragging = true;
                    offsetX = e.clientX - this.settingsModal.offsetLeft;
                    offsetY = e.clientY - this.settingsModal.offsetTop;
                });

                document.addEventListener('mousemove', (e) => {
                    if (isDragging) {
                        this.settingsModal.style.left = `${e.clientX - offsetX}px`;
                        this.settingsModal.style.top = `${e.clientY - offsetY}px`;
                    }
                });

                document.addEventListener('mouseup', () => {
                    isDragging = false;
                });

                this.settingsModalHeader.addEventListener('touchstart', (e) => {
                    isDragging = true;
                    offsetX = e.touches[0].clientX - this.settingsModal.offsetLeft;
                    offsetY = e.touches[0].clientY - this.settingsModal.offsetTop;
                });

                document.addEventListener('touchmove', (e) => {
                    if (isDragging) {
                        this.settingsModal.style.left = `${e.touches[0].clientX - offsetX}px`;
                        this.settingsModal.style.top = `${e.touches[0].clientY - offsetY}px`;
                    }
                });

                document.addEventListener('touchend', () => {
                    isDragging = false;
                });

                this.toggleI11.addEventListener('click', () => {
                    this.i11Toolbar.classList.toggle('hidden');
                });

                this.createCommentButton.addEventListener('click', async () => {
                    try {
                        const commentBody = this.sheetMusicInput.value;
                        await this.apiRequest('POST', 'issues/11/comments', { body: commentBody });
                        alert('新评论创建成功');
                        this.loadIssueAndComments();
                    } catch (error) {
                        console.error('创建评论时出错:', error);
                        alert('创建评论失败');
                    }
                });

                this.updateContentButton.addEventListener('click', async () => {
                    const highlightedButton = this.i11Toolbar.querySelector('button.highlighted');
                    if (!highlightedButton) {
                        alert('请先选择一个议题或评论进行高亮');
                        return;
                    }
                    const content = this.sheetMusicInput.value;
                    try {
                        if (highlightedButton.textContent === '议题 11 内容') {
                            await this.apiRequest('PATCH', 'issues/11', { body: content });
                        } else {
                            const commentId = highlightedButton.textContent.match(/评论 (\d+)/)[1];
                            await this.apiRequest('PATCH', `issues/comments/${commentId}`, { body: content });
                        }
                        alert('内容更新成功');
                        this.loadIssueAndComments();
                    } catch (error) {
                        console.error('更新内容时出错:', error);
                        alert('更新内容失败');
                    }
                });
            }

            async loadIssueAndComments() {
                this.i11Toolbar.innerHTML = '';
                try {
                    const issueData = await this.apiRequest('GET', 'issues/11');
                    const issueBody = issueData.body;
                    if (issueBody) {
                        const processedIssueBody = this.processSpaces(issueBody);
                        const issueButton = document.createElement('button');
                        issueButton.classList.add('bg-orange-500', 'hover:bg-orange-600', 'text-white', 'py-2', 'px-4', 'rounded', 'mr-2');
                        issueButton.textContent = '议题 11 内容';
                        issueButton.addEventListener('click', () => {
                            this.resetHighlight();
                            issueButton.classList.add('highlighted');
                            this.sheetMusicInput.value = processedIssueBody;
                            let parsedSheetMusic;
                            if (processedIssueBody.includes('V:')) {
                                parsedSheetMusic = this.parseSheetMusic(processedIssueBody);
                            } else {
                                parsedSheetMusic = `<span class="error">${processedIssueBody}</span>`;
                            }
                            this.canvas.innerHTML = `<pre>${parsedSheetMusic}</pre>`;
                        });
                        this.i11Toolbar.appendChild(issueButton);
                    }

                    const commentsData = await this.apiRequest('GET', 'issues/11/comments');
                    let n = 0;
                    commentsData.forEach(comment => {
                        n++;
                        const commentBody = comment.body;
                        if (commentBody) {
                            const processedCommentBody = this.processSpaces(commentBody);
                            const commentButton = document.createElement('button');
                            commentButton.classList.add('bg-pink-500', 'hover:bg-pink-600', 'text-white', 'py-2', 'px-4', 'rounded', 'mr-2');
                            commentButton.textContent = `C${n}`;
                            commentButton.addEventListener('click', () => {
                                this.resetHighlight();
                                commentButton.classList.add('highlighted');
                                this.sheetMusicInput.value = processedCommentBody;
                                let parsedSheetMusic;
                                if (processedCommentBody.includes('V:')) {
                                    parsedSheetMusic = this.parseSheetMusic(processedCommentBody);
                                } else {
                                    parsedSheetMusic = `<span class="error">${processedCommentBody}</span>`;
                                }
                                this.canvas.innerHTML = `<pre>${parsedSheetMusic}</pre>`;
                            });
                            this.i11Toolbar.appendChild(commentButton);
                        }
                    });
                } catch (error) {
                    console.error('加载 issue 或评论时出错:', error);
                }
            }
            parseSheetMusic(input) {
                const lines = input.split('\n');
                let output = '';
                
                lines.forEach(line => {
                    if (line.startsWith('Q:')) {
                        const content = line.substring(2).trim();
                        output += `<span class="blue-note">${this.parseMusicLine(content)}</span>`;
                    } else {
                        output += `<span class="green-text">${line}</span>`;
                    }
                    output += '<br>';
                });
                return output;
            }
            parseMusicLine(line) {
                let output = '';
                let currentNote = '';
                for (let i = 0; i < line.length; i++) {
                    const char = line[i];
                    if (/[0-9]/.test(char)) {
                        if (currentNote) {
                            output += this.formatNote(currentNote);
                            currentNote = '';
                        }
                        currentNote += char;
                    } else if (char === '/') {
                        currentNote += char;
                    } else if (char === '"') {
                        if (currentNote) {
                            const chord = this.extractChord(line, i);
                            output += this.formatNoteWithChord(currentNote, chord);
                            currentNote = '';
                            i += chord.length + 1;
                        }
                    } else {
                        if (currentNote) {
                            output += this.formatNote(currentNote);
                            currentNote = '';
                        }
                        output += char;
                    }
                }
                if (currentNote) {
                    output += this.formatNote(currentNote);
                }
                return output;
            }

            formatNote(note) {
                const match = note.match(/^(\d+)(\/+)$/);
                if (match) {
                    const digit = match[1];
                    const slashes = match[2].length;
                    if (slashes === 1) {
                        return `<span class="eighth-note">${digit}</span>`;
                    } else if (slashes === 2) {
                        return `<span class="sixteenth-note">${digit}</span>`;
                    }
                }
                return note;
            }

            formatNoteWithChord(note, chord) {
                const formattedNote = this.formatNote(note);
                return `<span class="note-with-chord"><span class="chord">${chord}</span>${formattedNote}</span>`;
            }

            extractChord(input, startIndex) {
                let chord = '';
                for (let i = startIndex + 1; i < input.length; i++) {
                    if (input[i] === '"') {
                        break;
                    }
                    chord += input[i];
                }
                return chord;
            }

            generateRandomSheet() {
                const notes = ['1', '2', '3', '4', '5', '6', '7'];
                const chords = ['"C"', '"Am"', '"Dm"', '"G"'];
                let randomSheet = '';
                for (let i = 0; i < 4; i++) {
                    for (let j = 0; j < 4; j++) {
                        const randomNote = notes[Math.floor(Math.random() * notes.length)];
                        const randomSlash = Math.random() > 0.5 ? '/' : '';
                        randomSheet += randomNote + randomSlash;
                        if (j === 3) {
                            const randomChord = chords[Math.floor(Math.random() * chords.length)];
                            randomSheet += ' ' + randomChord + ' ';
                        } else {
                            randomSheet += ' ';
                        }
                    }
                    randomSheet += '| ';
                }
                return randomSheet;
            }

            resetHighlight() {
                const buttons = this.i11Toolbar.querySelectorAll('button');
                buttons.forEach(button => {
                    button.classList.remove('highlighted');
                });
            }
        }

        new SheetMusicEditor();
    </script>
</body>

</html>
    
<!--
升级 
     以“Q:”开头才解析为乐谱，蓝色显示
 其他不解析，以绿色显示
 
return all new code
-->