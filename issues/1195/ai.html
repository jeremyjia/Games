<!DOCTYPE html>
<html>
<head>
    <title>æ™ºèƒ½åœºæ™¯æ’­æ”¾å™¨</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .scene-container {
            margin: 15px;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 8px;
            background: #f8f9fa;
        }
        .preview-img {
            max-width: 250px;
            max-height: 180px;
            margin: 10px 0;
            border: 2px solid #eee;
            border-radius: 4px;
        }
        #canvas {
            border: 2px solid #dee2e6;
            border-radius: 8px;
            margin-top: 20px;
        }
        .controls {
            padding: 15px;
            background: #e9ecef;
            border-radius: 8px;
            margin-bottom: 20px;
        }
        button {
            padding: 8px 16px;
            margin: 0 5px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            background: #007bff;
            color: white;
            transition: background 0.3s;
        }
        button:hover { background: #0056b3; }
        input[type="number"] {
            padding: 6px;
            border: 1px solid #ced4da;
            border-radius: 4px;
            width: 80px;
        }
        .loading {
            display: inline-block;
            width: 24px;
            height: 24px;
            border: 3px solid rgba(0,0,0,0.1);
            border-radius: 50%;
            border-top-color: #007bff;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <div class="controls">
        <button onclick="addNewScene()">â• æ·»åŠ åœºæ™¯</button>
        <label>ğŸ“º å¸§ç‡ï¼š<input type="number" id="fps" value="24" min="1" max="60"></label>
        <button onclick="togglePlay()">â–¶ æ’­æ”¾</button>
        <button onclick="stop()">â¹ åœæ­¢</button>
        <button onclick="clearAll()">ğŸ—‘ï¸ æ¸…ç©º</button>
        <p style="color:#666;margin-top:10px;">ğŸ’¡ æç¤ºï¼šè¾“å…¥ä¸­æ–‡è‡ªåŠ¨ç”Ÿæˆæ–‡å­—å¡ç‰‡ï¼Œè‹±æ–‡å°†å°è¯•è°ƒç”¨AIç”Ÿæˆå›¾ç‰‡</p>
    </div>
    
    <div id="scenesContainer"></div>
    <canvas id="canvas"></canvas>

    <script>
        // å…¨å±€çŠ¶æ€ç®¡ç†
        var scenes = [];
        var isPlaying = false;
        var currentFrame = 0;
        var lastFrameTime = 0;
        var canvas = document.getElementById('canvas');
        var ctx = canvas.getContext('2d');
        
        // åˆå§‹åŒ–ç”»å¸ƒ
        canvas.width = 800;
        canvas.height = 600;

        // æ·»åŠ æ–°åœºæ™¯
        function addNewScene() {
            var sceneId = Date.now();
            var sceneHTML = 
                '<div class="scene-container" id="scene-' + sceneId + '">' +
                    '<textarea placeholder="è¯·è¾“å…¥åœºæ™¯æè¿°..." rows="3" cols="50" style="width:100%;margin-bottom:10px;"></textarea>' +
                    '<div style="display:flex;align-items:center;gap:10px;">' +
                        '<button onclick="generateImage(' + sceneId + ')">ğŸ–¼ï¸ ç”Ÿæˆå›¾åƒ</button>' +
                        '<div class="img-container" style="position:relative;">' +
                            '<div class="loading" style="display:none;"></div>' +
                            '<img class="preview-img" id="preview-' + sceneId + '">' +
                        '</div>' +
                        '<button onclick="removeScene(' + sceneId + ')" style="background:#dc3545;">âŒ åˆ é™¤</button>' +
                    '</div>' +
                '</div>';
            document.getElementById('scenesContainer').insertAdjacentHTML('beforeend', sceneHTML);
            scenes.push({
                id: sceneId,
                description: '',
                image: null,
                loaded: false,
                loading: false
            });
        }

        // åˆ é™¤åœºæ™¯
        function removeScene(id) {
            var element = document.getElementById('scene-' + id);
            if (element) element.parentNode.removeChild(element);
            for (var i = 0; i < scenes.length; i++) {
                if (scenes[i].id === id) {
                    scenes.splice(i, 1);
                    break;
                }
            }
        }

        // æ¸…ç©ºæ‰€æœ‰åœºæ™¯
        function clearAll() {
            scenes = [];
            document.getElementById('scenesContainer').innerHTML = '';
            stop();
        }

        // å›¾åƒç”Ÿæˆä¸»é€»è¾‘
        function generateImage(sceneId) {
            var scene = scenes.find(function(s) { return s.id === sceneId; });
            var container = document.querySelector('#scene-' + sceneId + ' .img-container');
            var textarea = document.querySelector('#scene-' + sceneId + ' textarea');
            var previewImg = container.querySelector('img');
            var loadingSpinner = container.querySelector('.loading');
            
            if (!textarea.value.trim()) {
                alert('è¯·è¾“å…¥åœºæ™¯æè¿°å†…å®¹');
                return;
            }

            scene.loading = true;
            previewImg.src = '';
            loadingSpinner.style.display = 'block';

            var text = textarea.value;
            
            // ä¸­æ–‡æ£€æµ‹å¤„ç†
            if(hasChinese(text)) {
                generateChineseCard(scene, text, previewImg, loadingSpinner);
            } else {
                fetchImageFromAPI(text)
                    .then(function(blob) {
                        handleImageSuccess(scene, blob, previewImg, loadingSpinner);
                    })
                    .catch(function(error) {
                        console.log('APIå¤±è´¥:', error);
                        generateChineseCard(scene, text, previewImg, loadingSpinner);
                    });
            }
        }

        // ä¸­æ–‡æ£€æµ‹å‡½æ•°
        function hasChinese(str) {
            return /[\u4E00-\u9FA5]/.test(str);
        }

        // APIè¯·æ±‚æ–¹æ³•ï¼ˆå¸¦è¶…æ—¶å¤„ç†ï¼‰
        function fetchImageFromAPI(prompt) {
            return new Promise(function(resolve, reject) {
                var timeout = setTimeout(function() {
                    reject(new Error('è¯·æ±‚è¶…æ—¶'));
                }, 10000);

                var encodedPrompt = encodeURIComponent(prompt);
                var img = new Image();
                img.crossOrigin = "Anonymous";
                img.onload = function() {
                    clearTimeout(timeout);
                    var canvas = document.createElement('canvas');
                    canvas.width = img.width;
                    canvas.height = img.height;
                    var ctx = canvas.getContext('2d');
                    ctx.drawImage(img, 0, 0);
                    canvas.toBlob(resolve);
                };
                img.onerror = function(err) {
                    clearTimeout(timeout);
                    reject(err);
                };
                img.src = 'https://image.pollinations.ai/prompt/' + encodedPrompt + "?seed=202503&width=1024&height=768&model=default";
            });
        }

        // ä¸­æ–‡å¡ç‰‡ç”Ÿæˆå™¨
        function generateChineseCard(scene, text, previewImg, spinner) {
            var canvas = document.createElement('canvas');
            canvas.width = 800;
            canvas.height = 600;
            var ctx = canvas.getContext('2d');
            
            // èƒŒæ™¯æ¸å˜
            var gradient = ctx.createLinearGradient(0, 0, 800, 600);
            gradient.addColorStop(0, '#F8BBD0');
            gradient.addColorStop(1, '#B3E5FC');
            ctx.fillStyle = gradient;
            ctx.fillRect(0, 0, 800, 600);
            
            // å­—ä½“è®¾ç½®
            ctx.font = 'bold 38px "Microsoft YaHei", SimHei, sans-serif';
            ctx.fillStyle = '#2d3436';
            ctx.textBaseline = 'middle';
            
            // æ–‡å­—æ’ç‰ˆ
            wrapChineseText(ctx, text, 50, 100, 700, 50, 8);

            // è£…é¥°å…ƒç´ 
            ctx.beginPath();
            ctx.arc(700, 500, 60, 0, Math.PI * 2);
            ctx.fillStyle = 'rgba(255, 255, 255, 0.2)';
            ctx.fill();

            var img = new Image();
            img.onload = function() {
                scene.image = img;
                scene.loaded = true;
                scene.loading = false;
                previewImg.src = img.src;
                spinner.style.display = 'none';
            };
            img.src = canvas.toDataURL();
        }

        // æ™ºèƒ½ä¸­æ–‡æ¢è¡Œç®—æ³•
        function wrapChineseText(ctx, text, x, y, maxWidth, lineHeight, maxLines) {
            var lines = [];
            var currentLine = '';
            
            for (var i = 0; i < text.length; i++) {
                var char = text[i];
                var testLine = currentLine + char;
                var metrics = ctx.measureText(testLine);
                
                if (metrics.width > maxWidth) {
                    lines.push(currentLine);
                    currentLine = char;
                    if (lines.length >= maxLines) break;
                } else {
                    currentLine = testLine;
                }
            }
            
            if (currentLine && lines.length < maxLines) lines.push(currentLine);
            
            // å‚ç›´å±…ä¸­
            var totalHeight = lineHeight * lines.length;
            var startY = y + (600 - y - totalHeight) / 2;
            
            // ç»˜åˆ¶æ–‡å­—
            ctx.shadowColor = 'rgba(0, 0, 0, 0.15)';
            ctx.shadowBlur = 4;
            ctx.shadowOffsetX = 2;
            ctx.shadowOffsetY = 2;
            
            lines.forEach(function(line, index) {
                var textWidth = ctx.measureText(line).width;
                ctx.fillText(line, x + (maxWidth - textWidth)/2, startY + index * lineHeight);
            });
            
            // é‡ç½®é˜´å½±
            ctx.shadowColor = 'transparent';
        }

        // å¤„ç†å›¾åƒåŠ è½½æˆåŠŸ
        function handleImageSuccess(scene, blob, previewImg, spinner) {
            var img = new Image();
            img.onload = function() {
                scene.image = img;
                scene.loaded = true;
                scene.loading = false;
                previewImg.src = img.src;
                spinner.style.display = 'none';
            };
            img.src = URL.createObjectURL(blob);
        }

        // åŠ¨ç”»å¾ªç¯æ ¸å¿ƒ
        function animate(timestamp) {
            if (!isPlaying) return;

            var fps = document.getElementById('fps').value || 24;
            var frameInterval = 1000 / fps;
            
            if (timestamp - lastFrameTime >= frameInterval) {
                var sceneIndex = currentFrame % scenes.length;
                var scene = scenes[sceneIndex];
                
                if (scene && scene.loaded) {
                    ctx.clearRect(0, 0, canvas.width, canvas.height);
                    ctx.drawImage(scene.image, 0, 0, 800, 600);
                }
                
                currentFrame++;
                lastFrameTime = timestamp;
            }
            
            requestAnimationFrame(animate);
        }

        // æ’­æ”¾æ§åˆ¶
        function togglePlay() {
            isPlaying = !isPlaying;
            var btn = document.querySelector('button[onclick="togglePlay()"]');
            btn.textContent = isPlaying ? 'â¸ æš‚åœ' : 'â–¶ æ’­æ”¾';
            if (isPlaying) requestAnimationFrame(animate);
        }

        function stop() {
            isPlaying = false;
            currentFrame = 0;
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            document.querySelector('button[onclick="togglePlay()"]').textContent = 'â–¶ æ’­æ”¾';
        }
    </script>
</body>
</html>